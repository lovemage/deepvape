<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å™¨è¼‰å…¥æ¸¬è©¦ (ä¿®å¾©ç‰ˆ)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç®¡ç†å™¨è¼‰å…¥æ¸¬è©¦ (ä¿®å¾©ç‰ˆ)</h1>
    
    <div class="test-container">
        <h2>è…³æœ¬è¼‰å…¥ç‹€æ…‹</h2>
        <div id="scriptLoadingStatus"></div>
        <button onclick="checkScriptLoading()">é‡æ–°æª¢æŸ¥è…³æœ¬è¼‰å…¥</button>
    </div>
    
    <div class="test-container">
        <h2>ç®¡ç†å™¨å¯¦ä¾‹ç‹€æ…‹</h2>
        <div id="managerStatus"></div>
        <button onclick="checkManagerStatus()">é‡æ–°æª¢æŸ¥ç®¡ç†å™¨</button>
        <button onclick="forceInitializeManagers()">å¼·åˆ¶åˆå§‹åŒ–ç®¡ç†å™¨</button>
    </div>
    
    <div class="test-container">
        <h2>è©³ç´°è¨ºæ–·ä¿¡æ¯</h2>
        <div id="diagnosticInfo"></div>
        <button onclick="runDiagnostics()">é‹è¡Œå®Œæ•´è¨ºæ–·</button>
    </div>

    <script>
        // è…³æœ¬è¼‰å…¥ç‹€æ…‹è¿½è¹¤
        const scriptLoadStatus = {
            'js/product-manager.js': false,
            'js/inventory-manager.js': false,
            'js/order-manager.js': false
        };

        // å‹•æ…‹è¼‰å…¥è…³æœ¬çš„å‡½æ•¸
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¼‰å…¥
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    console.log(`è…³æœ¬ ${src} å·²å­˜åœ¨`);
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`âœ… è…³æœ¬è¼‰å…¥æˆåŠŸ: ${src}`);
                    scriptLoadStatus[src] = true;
                    resolve();
                };
                script.onerror = () => {
                    console.error(`âŒ è…³æœ¬è¼‰å…¥å¤±æ•—: ${src}`);
                    scriptLoadStatus[src] = false;
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // æŒ‰é †åºè¼‰å…¥æ‰€æœ‰ç®¡ç†å™¨è…³æœ¬
        async function loadAllScripts() {
            const scripts = [
                'js/product-manager.js',
                'js/inventory-manager.js',
                'js/order-manager.js'
            ];

            console.log('ğŸ”„ é–‹å§‹è¼‰å…¥ç®¡ç†å™¨è…³æœ¬...');
            
            for (const script of scripts) {
                try {
                    await loadScript(script);
                    // ç­‰å¾…ä¸€å°æ®µæ™‚é–“è®“è…³æœ¬åŸ·è¡Œ
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    console.error(`è¼‰å…¥ ${script} å¤±æ•—:`, error);
                }
            }

            console.log('ğŸ“‹ æ‰€æœ‰è…³æœ¬è¼‰å…¥å®Œæˆï¼Œç­‰å¾…ç®¡ç†å™¨åˆå§‹åŒ–...');
            
            // ç­‰å¾…ç®¡ç†å™¨å¯¦ä¾‹å‰µå»º
            await new Promise(resolve => setTimeout(resolve, 500));
            
            return true;
        }

        // æª¢æŸ¥è…³æœ¬è¼‰å…¥ç‹€æ…‹
        function checkScriptLoading() {
            const statusDiv = document.getElementById('scriptLoadingStatus');
            let html = '<h3>è…³æœ¬è¼‰å…¥ç‹€æ…‹:</h3>';
            
            Object.entries(scriptLoadStatus).forEach(([script, loaded]) => {
                const scriptElement = document.querySelector(`script[src="${script}"]`);
                const exists = !!scriptElement;
                
                html += `<div class="status ${loaded && exists ? 'success' : (exists ? 'warning' : 'error')}">
                    <strong>${script}:</strong>
                    ${exists ? 'ğŸ“„ æ¨™ç±¤å­˜åœ¨' : 'âŒ æ¨™ç±¤ä¸å­˜åœ¨'} | 
                    ${loaded ? 'âœ… è¼‰å…¥æˆåŠŸ' : 'âš ï¸ æœªè¼‰å…¥'}
                </div>`;
            });
            
            statusDiv.innerHTML = html;
        }

        // æª¢æŸ¥ç®¡ç†å™¨ç‹€æ…‹
        function checkManagerStatus() {
            const statusDiv = document.getElementById('managerStatus');
            let html = '<h3>ç®¡ç†å™¨å¯¦ä¾‹ç‹€æ…‹:</h3>';
            
            const managers = [
                { name: 'ProductManager', obj: window.ProductManager },
                { name: 'InventoryManager', obj: window.InventoryManager },
                { name: 'OrderManager', obj: window.OrderManager }
            ];
            
            managers.forEach(manager => {
                const exists = !!manager.obj;
                const initialized = manager.obj?.initialized;
                const hasInit = manager.obj && typeof manager.obj.init === 'function';
                
                html += `<div class="status ${exists ? (initialized ? 'success' : 'warning') : 'error'}">
                    <strong>${manager.name}:</strong>
                    ${exists ? 'âœ… å¯¦ä¾‹å­˜åœ¨' : 'âŒ å¯¦ä¾‹ä¸å­˜åœ¨'} |
                    ${hasInit ? 'ğŸ”§ æœ‰ init æ–¹æ³•' : 'âŒ ç„¡ init æ–¹æ³•'} |
                    ${initialized ? 'âœ… å·²åˆå§‹åŒ–' : 'âš ï¸ æœªåˆå§‹åŒ–'}
                </div>`;
            });
            
            statusDiv.innerHTML = html;
        }

        // å¼·åˆ¶åˆå§‹åŒ–ç®¡ç†å™¨
        async function forceInitializeManagers() {
            const statusDiv = document.getElementById('managerStatus');
            statusDiv.innerHTML = '<div class="status info"><span class="loading"></span> æ­£åœ¨å¼·åˆ¶åˆå§‹åŒ–ç®¡ç†å™¨...</div>';
            
            const managers = [
                { name: 'ProductManager', obj: window.ProductManager },
                { name: 'InventoryManager', obj: window.InventoryManager },
                { name: 'OrderManager', obj: window.OrderManager }
            ];
            
            let html = '<h3>å¼·åˆ¶åˆå§‹åŒ–çµæœ:</h3>';
            
            for (const manager of managers) {
                if (manager.obj && typeof manager.obj.init === 'function') {
                    try {
                        if (!manager.obj.initialized) {
                            await manager.obj.init();
                            html += `<div class="status success">âœ… ${manager.name} åˆå§‹åŒ–æˆåŠŸ</div>`;
                        } else {
                            html += `<div class="status info">â„¹ï¸ ${manager.name} å·²ç¶“åˆå§‹åŒ–</div>`;
                        }
                    } catch (error) {
                        html += `<div class="status error">âŒ ${manager.name} åˆå§‹åŒ–å¤±æ•—: ${error.message}</div>`;
                    }
                } else {
                    html += `<div class="status error">âŒ ${manager.name} ä¸å­˜åœ¨æˆ–ç„¡ init æ–¹æ³•</div>`;
                }
            }
            
            statusDiv.innerHTML = html;
        }

        // é‹è¡Œå®Œæ•´è¨ºæ–·
        async function runDiagnostics() {
            const statusDiv = document.getElementById('diagnosticInfo');
            statusDiv.innerHTML = '<div class="status info"><span class="loading"></span> æ­£åœ¨é‹è¡Œè¨ºæ–·...</div>';
            
            let diagnostics = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                currentUrl: window.location.href,
                scripts: {},
                managers: {},
                errors: []
            };
            
            // æª¢æŸ¥è…³æœ¬
            Object.keys(scriptLoadStatus).forEach(script => {
                const scriptElement = document.querySelector(`script[src="${script}"]`);
                diagnostics.scripts[script] = {
                    elementExists: !!scriptElement,
                    loadStatus: scriptLoadStatus[script],
                    src: scriptElement?.src || 'N/A'
                };
            });
            
            // æª¢æŸ¥ç®¡ç†å™¨
            ['ProductManager', 'InventoryManager', 'OrderManager'].forEach(name => {
                const manager = window[name];
                diagnostics.managers[name] = {
                    exists: !!manager,
                    type: typeof manager,
                    initialized: manager?.initialized,
                    hasInit: manager && typeof manager.init === 'function',
                    constructor: manager?.constructor?.name,
                    methods: manager ? Object.getOwnPropertyNames(Object.getPrototypeOf(manager)).filter(name => typeof manager[name] === 'function') : []
                };
            });
            
            // æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤
            const originalError = console.error;
            const errors = [];
            console.error = function(...args) {
                errors.push(args.join(' '));
                originalError.apply(console, args);
            };
            
            // å˜—è©¦é‡æ–°è¼‰å…¥è…³æœ¬
            try {
                await loadAllScripts();
                diagnostics.reloadAttempt = 'success';
            } catch (error) {
                diagnostics.reloadAttempt = 'failed';
                diagnostics.reloadError = error.message;
            }
            
            diagnostics.errors = errors;
            
            let html = '<h3>å®Œæ•´è¨ºæ–·å ±å‘Š:</h3>';
            html += `<pre>${JSON.stringify(diagnostics, null, 2)}</pre>`;
            
            statusDiv.innerHTML = html;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è¨ºæ–·...');
            
            // ç­‰å¾…ä¸€ä¸‹è®“ç¾æœ‰è…³æœ¬è¼‰å…¥
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // æª¢æŸ¥ç•¶å‰ç‹€æ…‹
            checkScriptLoading();
            checkManagerStatus();
            
            // å¦‚æœç®¡ç†å™¨æœªè¼‰å…¥ï¼Œå˜—è©¦é‡æ–°è¼‰å…¥
            if (!window.ProductManager || !window.InventoryManager || !window.OrderManager) {
                console.log('âš ï¸ æª¢æ¸¬åˆ°ç®¡ç†å™¨æœªè¼‰å…¥ï¼Œå˜—è©¦é‡æ–°è¼‰å…¥...');
                try {
                    await loadAllScripts();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    checkManagerStatus();
                } catch (error) {
                    console.error('é‡æ–°è¼‰å…¥å¤±æ•—:', error);
                }
            }
        });

        // å®šæœŸæª¢æŸ¥ç‹€æ…‹
        setInterval(() => {
            checkManagerStatus();
        }, 5000);
    </script>
</body>
</html> 