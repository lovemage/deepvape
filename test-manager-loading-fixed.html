<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理器載入測試 (修復版)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>🔧 管理器載入測試 (修復版)</h1>
    
    <div class="test-container">
        <h2>腳本載入狀態</h2>
        <div id="scriptLoadingStatus"></div>
        <button onclick="checkScriptLoading()">重新檢查腳本載入</button>
    </div>
    
    <div class="test-container">
        <h2>管理器實例狀態</h2>
        <div id="managerStatus"></div>
        <button onclick="checkManagerStatus()">重新檢查管理器</button>
        <button onclick="forceInitializeManagers()">強制初始化管理器</button>
    </div>
    
    <div class="test-container">
        <h2>詳細診斷信息</h2>
        <div id="diagnosticInfo"></div>
        <button onclick="runDiagnostics()">運行完整診斷</button>
    </div>

    <script>
        // 腳本載入狀態追蹤
        const scriptLoadStatus = {
            'js/product-manager.js': false,
            'js/inventory-manager.js': false,
            'js/order-manager.js': false
        };

        // 動態載入腳本的函數
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // 檢查是否已經載入
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    console.log(`腳本 ${src} 已存在`);
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`✅ 腳本載入成功: ${src}`);
                    scriptLoadStatus[src] = true;
                    resolve();
                };
                script.onerror = () => {
                    console.error(`❌ 腳本載入失敗: ${src}`);
                    scriptLoadStatus[src] = false;
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // 按順序載入所有管理器腳本
        async function loadAllScripts() {
            const scripts = [
                'js/product-manager.js',
                'js/inventory-manager.js',
                'js/order-manager.js'
            ];

            console.log('🔄 開始載入管理器腳本...');
            
            for (const script of scripts) {
                try {
                    await loadScript(script);
                    // 等待一小段時間讓腳本執行
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    console.error(`載入 ${script} 失敗:`, error);
                }
            }

            console.log('📋 所有腳本載入完成，等待管理器初始化...');
            
            // 等待管理器實例創建
            await new Promise(resolve => setTimeout(resolve, 500));
            
            return true;
        }

        // 檢查腳本載入狀態
        function checkScriptLoading() {
            const statusDiv = document.getElementById('scriptLoadingStatus');
            let html = '<h3>腳本載入狀態:</h3>';
            
            Object.entries(scriptLoadStatus).forEach(([script, loaded]) => {
                const scriptElement = document.querySelector(`script[src="${script}"]`);
                const exists = !!scriptElement;
                
                html += `<div class="status ${loaded && exists ? 'success' : (exists ? 'warning' : 'error')}">
                    <strong>${script}:</strong>
                    ${exists ? '📄 標籤存在' : '❌ 標籤不存在'} | 
                    ${loaded ? '✅ 載入成功' : '⚠️ 未載入'}
                </div>`;
            });
            
            statusDiv.innerHTML = html;
        }

        // 檢查管理器狀態
        function checkManagerStatus() {
            const statusDiv = document.getElementById('managerStatus');
            let html = '<h3>管理器實例狀態:</h3>';
            
            const managers = [
                { name: 'ProductManager', obj: window.ProductManager },
                { name: 'InventoryManager', obj: window.InventoryManager },
                { name: 'OrderManager', obj: window.OrderManager }
            ];
            
            managers.forEach(manager => {
                const exists = !!manager.obj;
                const initialized = manager.obj?.initialized;
                const hasInit = manager.obj && typeof manager.obj.init === 'function';
                
                html += `<div class="status ${exists ? (initialized ? 'success' : 'warning') : 'error'}">
                    <strong>${manager.name}:</strong>
                    ${exists ? '✅ 實例存在' : '❌ 實例不存在'} |
                    ${hasInit ? '🔧 有 init 方法' : '❌ 無 init 方法'} |
                    ${initialized ? '✅ 已初始化' : '⚠️ 未初始化'}
                </div>`;
            });
            
            statusDiv.innerHTML = html;
        }

        // 強制初始化管理器
        async function forceInitializeManagers() {
            const statusDiv = document.getElementById('managerStatus');
            statusDiv.innerHTML = '<div class="status info"><span class="loading"></span> 正在強制初始化管理器...</div>';
            
            const managers = [
                { name: 'ProductManager', obj: window.ProductManager },
                { name: 'InventoryManager', obj: window.InventoryManager },
                { name: 'OrderManager', obj: window.OrderManager }
            ];
            
            let html = '<h3>強制初始化結果:</h3>';
            
            for (const manager of managers) {
                if (manager.obj && typeof manager.obj.init === 'function') {
                    try {
                        if (!manager.obj.initialized) {
                            await manager.obj.init();
                            html += `<div class="status success">✅ ${manager.name} 初始化成功</div>`;
                        } else {
                            html += `<div class="status info">ℹ️ ${manager.name} 已經初始化</div>`;
                        }
                    } catch (error) {
                        html += `<div class="status error">❌ ${manager.name} 初始化失敗: ${error.message}</div>`;
                    }
                } else {
                    html += `<div class="status error">❌ ${manager.name} 不存在或無 init 方法</div>`;
                }
            }
            
            statusDiv.innerHTML = html;
        }

        // 運行完整診斷
        async function runDiagnostics() {
            const statusDiv = document.getElementById('diagnosticInfo');
            statusDiv.innerHTML = '<div class="status info"><span class="loading"></span> 正在運行診斷...</div>';
            
            let diagnostics = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                currentUrl: window.location.href,
                scripts: {},
                managers: {},
                errors: []
            };
            
            // 檢查腳本
            Object.keys(scriptLoadStatus).forEach(script => {
                const scriptElement = document.querySelector(`script[src="${script}"]`);
                diagnostics.scripts[script] = {
                    elementExists: !!scriptElement,
                    loadStatus: scriptLoadStatus[script],
                    src: scriptElement?.src || 'N/A'
                };
            });
            
            // 檢查管理器
            ['ProductManager', 'InventoryManager', 'OrderManager'].forEach(name => {
                const manager = window[name];
                diagnostics.managers[name] = {
                    exists: !!manager,
                    type: typeof manager,
                    initialized: manager?.initialized,
                    hasInit: manager && typeof manager.init === 'function',
                    constructor: manager?.constructor?.name,
                    methods: manager ? Object.getOwnPropertyNames(Object.getPrototypeOf(manager)).filter(name => typeof manager[name] === 'function') : []
                };
            });
            
            // 檢查控制台錯誤
            const originalError = console.error;
            const errors = [];
            console.error = function(...args) {
                errors.push(args.join(' '));
                originalError.apply(console, args);
            };
            
            // 嘗試重新載入腳本
            try {
                await loadAllScripts();
                diagnostics.reloadAttempt = 'success';
            } catch (error) {
                diagnostics.reloadAttempt = 'failed';
                diagnostics.reloadError = error.message;
            }
            
            diagnostics.errors = errors;
            
            let html = '<h3>完整診斷報告:</h3>';
            html += `<pre>${JSON.stringify(diagnostics, null, 2)}</pre>`;
            
            statusDiv.innerHTML = html;
        }

        // 頁面載入時自動執行
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 頁面載入完成，開始診斷...');
            
            // 等待一下讓現有腳本載入
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 檢查當前狀態
            checkScriptLoading();
            checkManagerStatus();
            
            // 如果管理器未載入，嘗試重新載入
            if (!window.ProductManager || !window.InventoryManager || !window.OrderManager) {
                console.log('⚠️ 檢測到管理器未載入，嘗試重新載入...');
                try {
                    await loadAllScripts();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    checkManagerStatus();
                } catch (error) {
                    console.error('重新載入失敗:', error);
                }
            }
        });

        // 定期檢查狀態
        setInterval(() => {
            checkManagerStatus();
        }, 5000);
    </script>
</body>
</html> 