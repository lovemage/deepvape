<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©³ç´°éŒ¯èª¤æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #e7f3ff; color: #004085; border: 1px solid #b3d7ff; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è©³ç´°éŒ¯èª¤æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ APIé‡‘é‘°è³‡è¨Š</h3>
            <div id="apiKeyInfo" class="results info">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ›ï¸ èˆŠç‰ˆPlaces APIè©³ç´°æ¸¬è©¦</h3>
            <button onclick="testLegacyDetailed()" class="test-btn">è©³ç´°æ¸¬è©¦èˆŠç‰ˆAPI</button>
            <div id="legacyDetailed" class="results"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ†• æ–°ç‰ˆPlaces APIè©³ç´°æ¸¬è©¦</h3>
            <button onclick="testNewDetailed()" class="test-btn">è©³ç´°æ¸¬è©¦æ–°ç‰ˆAPI</button>
            <div id="newDetailed" class="results"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ APIæœå‹™æª¢æŸ¥</h3>
            <button onclick="checkServices()" class="test-btn">æª¢æŸ¥æ‰€æœ‰æœå‹™</button>
            <div id="serviceCheck" class="results"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ’¡ è§£æ±ºå»ºè­°</h3>
            <div id="suggestions" class="results warning">
æ ¹æ“šæ¸¬è©¦çµæœï¼Œä»¥ä¸‹æ˜¯å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼š

ğŸ”‘ APIé‡‘é‘°å•é¡Œï¼š
1. å‰å¾€ Google Cloud Console
2. é€²å…¥ APIs & Services > Library
3. æœå°‹ä¸¦å•Ÿç”¨ä»¥ä¸‹æœå‹™ï¼š
   - Places API (èˆŠç‰ˆ)
   - Places API (New)
   - Geocoding API (å¯é¸)

ğŸ”’ APIé‡‘é‘°é™åˆ¶ï¼š
1. é€²å…¥ APIs & Services > Credentials
2. ç·¨è¼¯ä½ çš„APIé‡‘é‘°
3. åœ¨ "API restrictions" ä¸­é¸æ“‡ "Restrict key"
4. å‹¾é¸ä»¥ä¸‹APIï¼š
   âœ… Maps JavaScript API
   âœ… Places API
   âœ… Places API (New)

ğŸ’³ è¨ˆè²»è¨­å®šï¼š
1. ç¢ºèªå·²è¨­å®šè¨ˆè²»å¸³æˆ¶
2. æª¢æŸ¥APIé…é¡æ˜¯å¦è¶³å¤ 
3. æ–°ç‰ˆPlaces APIå¯èƒ½éœ€è¦å•Ÿç”¨è¨ˆè²»

ğŸŒ ç¶²åŸŸé™åˆ¶ï¼š
1. å¦‚æœè¨­å®šäº†HTTP referreré™åˆ¶
2. ç¢ºèªåŒ…å«ï¼š
   - http://localhost:*
   - https://deepvape.netlify.app/*
            </div>
        </div>
    </div>

    <script>
        let apiKey = '';

        // åˆå§‹åŒ–ä¸¦é¡¯ç¤ºAPIé‡‘é‘°è³‡è¨Š
        async function initAndShowApiKey() {
            try {
                const response = await fetch('/.netlify/functions/get-map-config');
                const config = await response.json();
                
                if (config.success && config.apiKey) {
                    apiKey = config.apiKey;
                    
                    document.getElementById('apiKeyInfo').textContent = `
âœ… APIé‡‘é‘°è¼‰å…¥æˆåŠŸ

å®Œæ•´é‡‘é‘°: ${apiKey}
é‡‘é‘°é•·åº¦: ${apiKey.length} å­—å…ƒ
æ ¼å¼æª¢æŸ¥: ${apiKey.startsWith('AIza') ? 'âœ… æ­£ç¢º' : 'âŒ æ ¼å¼å¯èƒ½æœ‰èª¤'}
é‡‘é‘°å‰ç¶´: ${apiKey.substring(0, 10)}...
é‡‘é‘°å¾Œç¶´: ...${apiKey.substring(apiKey.length - 10)}

è«‹è¤‡è£½æ­¤é‡‘é‘°åˆ°Google Cloud Consoleé€²è¡Œæª¢æŸ¥`;
                } else {
                    throw new Error('ç„¡æ³•å–å¾—APIé‡‘é‘°');
                }
            } catch (error) {
                document.getElementById('apiKeyInfo').className = 'results error';
                document.getElementById('apiKeyInfo').textContent = `âŒ APIé‡‘é‘°è¼‰å…¥å¤±æ•—: ${error.message}`;
            }
        }

        // è©³ç´°æ¸¬è©¦èˆŠç‰ˆPlaces API
        async function testLegacyDetailed() {
            const resultsDiv = document.getElementById('legacyDetailed');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ”„ è©³ç´°æ¸¬è©¦èˆŠç‰ˆPlaces API...';

            if (!apiKey) await initAndShowApiKey();

            try {
                // æ¸¬è©¦å¤šå€‹èˆŠç‰ˆAPIç«¯é»
                const tests = [
                    {
                        name: 'Find Place From Text',
                        url: `https://maps.googleapis.com/maps/api/place/findplacefromtext/json?input=å°åŒ—è»Šç«™&inputtype=textquery&fields=place_id,name&key=${apiKey}`
                    },
                    {
                        name: 'Nearby Search',
                        url: `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=25.0330,121.5654&radius=1000&type=convenience_store&key=${apiKey}`
                    },
                    {
                        name: 'Text Search',
                        url: `https://maps.googleapis.com/maps/api/place/textsearch/json?query=7-11+å°åŒ—&key=${apiKey}`
                    }
                ];

                let results = 'èˆŠç‰ˆPlaces APIæ¸¬è©¦çµæœ:\n\n';

                for (const test of tests) {
                    try {
                        const response = await fetch(test.url);
                        const data = await response.json();
                        
                        results += `ğŸ“ ${test.name}:\n`;
                        results += `   ç‹€æ…‹ç¢¼: ${response.status}\n`;
                        results += `   APIç‹€æ…‹: ${data.status || 'N/A'}\n`;
                        
                        if (data.error_message) {
                            results += `   éŒ¯èª¤è¨Šæ¯: ${data.error_message}\n`;
                        }
                        
                        if (data.results && data.results.length > 0) {
                            results += `   çµæœæ•¸é‡: ${data.results.length}\n`;
                        } else if (data.candidates && data.candidates.length > 0) {
                            results += `   çµæœæ•¸é‡: ${data.candidates.length}\n`;
                        } else {
                            results += `   çµæœæ•¸é‡: 0\n`;
                        }
                        
                        results += `   å®Œæ•´å›æ‡‰: ${JSON.stringify(data, null, 2)}\n\n`;
                        
                    } catch (error) {
                        results += `ğŸ“ ${test.name}:\n`;
                        results += `   âŒ è«‹æ±‚å¤±æ•—: ${error.message}\n\n`;
                    }
                }

                resultsDiv.className = 'results info';
                resultsDiv.textContent = results;

            } catch (error) {
                resultsDiv.className = 'results error';
                resultsDiv.textContent = `âŒ èˆŠç‰ˆAPIæ¸¬è©¦å¤±æ•—: ${error.message}`;
            }
        }

        // è©³ç´°æ¸¬è©¦æ–°ç‰ˆPlaces API
        async function testNewDetailed() {
            const resultsDiv = document.getElementById('newDetailed');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ”„ è©³ç´°æ¸¬è©¦æ–°ç‰ˆPlaces API...';

            if (!apiKey) await initAndShowApiKey();

            try {
                const tests = [
                    {
                        name: 'Text Search (New)',
                        url: 'https://places.googleapis.com/v1/places:searchText',
                        body: { textQuery: 'å°åŒ—è»Šç«™', maxResultCount: 1 },
                        fieldMask: 'places.id,places.displayName'
                    },
                    {
                        name: 'Nearby Search (New)',
                        url: 'https://places.googleapis.com/v1/places:searchNearby',
                        body: {
                            locationRestriction: {
                                circle: {
                                    center: { latitude: 25.0330, longitude: 121.5654 },
                                    radius: 1000.0
                                }
                            },
                            includedTypes: ['convenience_store'],
                            maxResultCount: 5
                        },
                        fieldMask: 'places.id,places.displayName,places.formattedAddress'
                    }
                ];

                let results = 'æ–°ç‰ˆPlaces APIæ¸¬è©¦çµæœ:\n\n';

                for (const test of tests) {
                    try {
                        const response = await fetch(test.url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Goog-Api-Key': apiKey,
                                'X-Goog-FieldMask': test.fieldMask
                            },
                            body: JSON.stringify(test.body)
                        });

                        const responseText = await response.text();
                        let data;
                        
                        try {
                            data = JSON.parse(responseText);
                        } catch {
                            data = { rawResponse: responseText };
                        }

                        results += `ğŸ†• ${test.name}:\n`;
                        results += `   ç‹€æ…‹ç¢¼: ${response.status}\n`;
                        results += `   ç‹€æ…‹æ–‡å­—: ${response.statusText}\n`;
                        
                        // é¡¯ç¤ºå›æ‡‰æ¨™é ­
                        results += `   å›æ‡‰æ¨™é ­:\n`;
                        for (const [key, value] of response.headers.entries()) {
                            results += `     ${key}: ${value}\n`;
                        }
                        
                        if (data.error) {
                            results += `   éŒ¯èª¤ä»£ç¢¼: ${data.error.code}\n`;
                            results += `   éŒ¯èª¤è¨Šæ¯: ${data.error.message}\n`;
                            results += `   éŒ¯èª¤ç‹€æ…‹: ${data.error.status}\n`;
                        }
                        
                        if (data.places && data.places.length > 0) {
                            results += `   çµæœæ•¸é‡: ${data.places.length}\n`;
                        }
                        
                        results += `   å®Œæ•´å›æ‡‰: ${JSON.stringify(data, null, 2)}\n\n`;
                        
                    } catch (error) {
                        results += `ğŸ†• ${test.name}:\n`;
                        results += `   âŒ è«‹æ±‚å¤±æ•—: ${error.message}\n\n`;
                    }
                }

                resultsDiv.className = 'results info';
                resultsDiv.textContent = results;

            } catch (error) {
                resultsDiv.className = 'results error';
                resultsDiv.textContent = `âŒ æ–°ç‰ˆAPIæ¸¬è©¦å¤±æ•—: ${error.message}`;
            }
        }

        // æª¢æŸ¥APIæœå‹™ç‹€æ…‹
        async function checkServices() {
            const resultsDiv = document.getElementById('serviceCheck');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ“Š æª¢æŸ¥APIæœå‹™ç‹€æ…‹...';

            const serviceInfo = `
ğŸ” APIæœå‹™æª¢æŸ¥æ¸…å–®

ç•¶å‰ä½¿ç”¨çš„APIé‡‘é‘°: ${apiKey || 'æœªè¼‰å…¥'}

ğŸ“‹ éœ€è¦åœ¨Google Cloud Consoleä¸­å•Ÿç”¨çš„æœå‹™ï¼š

1. ğŸ—ºï¸ Maps JavaScript API
   - æœå‹™åç¨±: maps-backend.googleapis.com
   - ç‹€æ…‹: âœ… æ­£å¸¸ (åœ°åœ–å¯é¡¯ç¤º)

2. ğŸ›ï¸ Places API (èˆŠç‰ˆ)
   - æœå‹™åç¨±: places-backend.googleapis.com
   - ç‹€æ…‹: âŒ å¯èƒ½æœªå•Ÿç”¨æˆ–ç„¡æ¬Šé™

3. ğŸ†• Places API (New)
   - æœå‹™åç¨±: places.googleapis.com
   - ç‹€æ…‹: âŒ å¯èƒ½æœªå•Ÿç”¨æˆ–ç„¡æ¬Šé™

ğŸ”§ ç«‹å³æª¢æŸ¥æ­¥é©Ÿï¼š

1. å‰å¾€ Google Cloud Console:
   https://console.cloud.google.com/

2. é¸æ“‡æ­£ç¢ºçš„å°ˆæ¡ˆ

3. é€²å…¥ APIs & Services > Library

4. æœå°‹ä¸¦ç¢ºèªä»¥ä¸‹æœå‹™å·²å•Ÿç”¨ï¼š
   â–¡ "Places API" (èˆŠç‰ˆ)
   â–¡ "Places API (New)" (æ–°ç‰ˆ)

5. é€²å…¥ APIs & Services > Credentials

6. æ‰¾åˆ°ä¸¦ç·¨è¼¯ä½ çš„APIé‡‘é‘°

7. åœ¨ "API restrictions" ä¸­ï¼š
   - é¸æ“‡ "Restrict key"
   - å‹¾é¸æ‰€æœ‰éœ€è¦çš„APIæœå‹™

8. åœ¨ "Application restrictions" ä¸­ï¼š
   - è¨­å®šé©ç•¶çš„ç¶²åŸŸé™åˆ¶
   - åŒ…å« localhost å’Œä½ çš„æ­£å¼ç¶²åŸŸ

ğŸ’¡ å¦‚æœæœå‹™å·²å•Ÿç”¨ä½†ä»æœ‰å•é¡Œï¼š
- æª¢æŸ¥è¨ˆè²»å¸³æˆ¶æ˜¯å¦å·²è¨­å®š
- ç¢ºèªAPIé…é¡æ˜¯å¦è¶³å¤ 
- å˜—è©¦å‰µå»ºæ–°çš„APIé‡‘é‘°
- æª¢æŸ¥å°ˆæ¡ˆæ¬Šé™è¨­å®š`;

            resultsDiv.className = 'results warning';
            resultsDiv.textContent = serviceInfo;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initAndShowApiKey();
        });
    </script>
</body>
</html> 