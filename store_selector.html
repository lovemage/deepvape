<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸æ“‡å–è²¨é–€å¸‚ - DeepVape</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .selector-panel {
            padding: 40px;
            background: #f8f9fa;
        }

        .map-panel {
            position: relative;
            background: #e9ecef;
        }

        .step {
            margin-bottom: 30px;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .select-container {
            position: relative;
        }

        select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        select:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .store-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
        }

        .store-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .store-item:hover {
            background: #f8f9fa;
        }

        .store-item.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .store-item:last-child {
            border-bottom: none;
        }

        .store-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .store-address {
            color: #666;
            font-size: 0.9em;
        }

        .store-item.selected .store-address {
            color: rgba(255,255,255,0.9);
        }

        .confirm-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        .selected-info {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .selected-info.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .order-info {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .order-number {
            margin-bottom: 20px;
        }

        .order-number label {
            font-weight: bold;
            color: #2c3e50;
            display: block;
            margin-bottom: 10px;
        }

        .order-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        #orderNumber {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
            letter-spacing: 1px;
        }

        .copy-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: #28a745;
        }

        .customer-service p {
            color: #666;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .line-btn {
            display: inline-block;
            background: #00C300;
            color: white;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 195, 0, 0.3);
        }

        .line-btn:hover {
            background: #00A300;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 195, 0, 0.4);
        }

        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .selector-panel {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .order-display {
                flex-direction: column;
                gap: 15px;
            }

            #orderNumber {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª é¸æ“‡å–è²¨é–€å¸‚</h1>
            <p>è«‹ä¾åºé¸æ“‡ç¸£å¸‚ã€å€åŸŸåŠé–€å¸‚ï¼Œæˆ‘å€‘å°‡ç‚ºæ‚¨ä¿ç•™å•†å“è‡³æŒ‡å®šé–€å¸‚</p>
        </div>

        <div class="content">
            <div class="selector-panel">
                <!-- æ­¥é©Ÿ1: é¸æ“‡é–€å¸‚é¡å‹ -->
                <div class="step">
                    <div class="step-title">
                        <span class="step-number">1</span>
                        é¸æ“‡é–€å¸‚é¡å‹
                    </div>
                    <div class="select-container">
                        <select id="storeTypeSelect">
                            <option value="711">7-ELEVEN</option>
                            <option value="family">å…¨å®¶ä¾¿åˆ©å•†åº—</option>
                        </select>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ2: é¸æ“‡ç¸£å¸‚ -->
                <div class="step">
                    <div class="step-title">
                        <span class="step-number">2</span>
                        é¸æ“‡ç¸£å¸‚
                    </div>
                    <div class="select-container">
                        <select id="citySelect">
                            <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
                        </select>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ3: é¸æ“‡å€åŸŸ -->
                <div class="step">
                    <div class="step-title">
                        <span class="step-number">3</span>
                        é¸æ“‡å€åŸŸ
                    </div>
                    <div class="select-container">
                        <select id="districtSelect" disabled>
                            <option value="">è«‹å…ˆé¸æ“‡ç¸£å¸‚</option>
                        </select>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ4: é¸æ“‡é–€å¸‚ -->
                <div class="step">
                    <div class="step-title">
                        <span class="step-number">4</span>
                        é¸æ“‡é–€å¸‚
                    </div>
                    <div id="storeList" class="store-list">
                        <div class="loading">è«‹å…ˆé¸æ“‡é–€å¸‚é¡å‹ã€ç¸£å¸‚å’Œå€åŸŸ</div>
                    </div>
                </div>

                <button id="confirmBtn" class="confirm-btn" disabled>
                    ç¢ºèªé¸æ“‡æ­¤é–€å¸‚
                </button>
                
                <!-- é™¤éŒ¯æŒ‰éˆ• (é–‹ç™¼ç”¨) -->
                <button id="debugBtn" class="confirm-btn" style="background: #ff6b6b; margin-top: 10px;" onclick="storeSelector.testLocalData()">ğŸ”§ æ¸¬è©¦æœ¬åœ°è³‡æ–™</button>

                <!-- æ­¥é©Ÿ5: ç”Ÿæˆè¨‚å–® -->
                <div id="orderStep" class="step" style="display: none;">
                    <div class="step-title">
                        <span class="step-number">5</span>
                        è¨‚å–®å·²ç”Ÿæˆ
                    </div>
                    <div class="order-info">
                        <div class="order-number">
                            <label>è¨‚å–®è™Ÿç¢¼ï¼š</label>
                            <div class="order-display">
                                <span id="orderNumber">ORD202412240001</span>
                                <button id="copyBtn" class="copy-btn" onclick="copyOrderNumber()">ğŸ“‹ è¤‡è£½</button>
                            </div>
                        </div>
                        <div class="customer-service">
                            <p>è«‹å°‡è¨‚å–®è™Ÿç¢¼è¤‡è£½çµ¦å®¢æœç¢ºèªè¨‚å–®</p>
                            <a href="https://line.me/ti/p/@deepvape" target="_blank" class="line-btn">
                                ğŸ’¬ è¯ç¹«å®¢æœ Line
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="map-panel">
                <div id="selectedInfo" class="selected-info">
                    <h3 id="selectedStoreName">é–€å¸‚åç¨±</h3>
                    <p id="selectedStoreAddress">é–€å¸‚åœ°å€</p>
                    <p id="selectedStorePhone">è¯çµ¡é›»è©±</p>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸ï¼šæœ¬åœ°7-ELEVENé–€å¸‚è³‡æ–™åº«
        const sevenElevenStores = {
            'å°åŒ—å¸‚': {
                'ä¸­æ­£å€': [
                    { id: 'TP001', name: '7-ELEVEN ä¸­æ­£é–€å¸‚', address: 'å°åŒ—å¸‚ä¸­æ­£å€ä¸­æ­£è·¯123è™Ÿ', phone: '02-2345-6789', lat: 25.0330, lng: 121.5654 },
                    { id: 'TP002', name: '7-ELEVEN å°åŒ—è»Šç«™é–€å¸‚', address: 'å°åŒ—å¸‚ä¸­æ­£å€åŒ—å¹³è¥¿è·¯3è™Ÿ', phone: '02-2345-6790', lat: 25.0478, lng: 121.5170 },
                    { id: 'TP003', name: '7-ELEVEN è¥¿é–€é–€å¸‚', address: 'å°åŒ—å¸‚ä¸­æ­£å€è¥¿é–€è·¯88è™Ÿ', phone: '02-2345-6791', lat: 25.0419, lng: 121.5070 }
                ],
                'å¤§å®‰å€': [
                    { id: 'TP004', name: '7-ELEVEN å¿ å­é–€å¸‚', address: 'å°åŒ—å¸‚å¤§å®‰å€å¿ å­æ±è·¯å››æ®µ123è™Ÿ', phone: '02-2345-6792', lat: 25.0415, lng: 121.5440 },
                    { id: 'TP005', name: '7-ELEVEN æ•¦å—é–€å¸‚', address: 'å°åŒ—å¸‚å¤§å®‰å€æ•¦åŒ–å—è·¯ä¸€æ®µ456è™Ÿ', phone: '02-2345-6793', lat: 25.0400, lng: 121.5500 },
                    { id: 'TP006', name: '7-ELEVEN æ±å€é–€å¸‚', address: 'å°åŒ—å¸‚å¤§å®‰å€å¤§å®‰è·¯ä¸€æ®µ789è™Ÿ', phone: '02-2345-6794', lat: 25.0380, lng: 121.5380 }
                ],
                'ä¿¡ç¾©å€': [
                    { id: 'TP007', name: '7-ELEVEN ä¿¡ç¾©é–€å¸‚', address: 'å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ', phone: '02-2345-6795', lat: 25.0330, lng: 121.5654 },
                    { id: 'TP008', name: '7-ELEVEN 101é–€å¸‚', address: 'å°åŒ—å¸‚ä¿¡ç¾©å€å¸‚åºœè·¯45è™Ÿ', phone: '02-2345-6796', lat: 25.0340, lng: 121.5664 },
                    { id: 'TP009', name: '7-ELEVEN æ¾é«˜é–€å¸‚', address: 'å°åŒ—å¸‚ä¿¡ç¾©å€æ¾é«˜è·¯11è™Ÿ', phone: '02-2345-6797', lat: 25.0350, lng: 121.5674 }
                ]
            },
            'æ–°åŒ—å¸‚': {
                'æ¿æ©‹å€': [
                    { id: 'NB001', name: '7-ELEVEN æ¿æ©‹é–€å¸‚', address: 'æ–°åŒ—å¸‚æ¿æ©‹å€ä¸­å±±è·¯ä¸€æ®µ123è™Ÿ', phone: '02-2960-1234', lat: 25.0118, lng: 121.4627 },
                    { id: 'NB002', name: '7-ELEVEN æ–°æ¿é–€å¸‚', address: 'æ–°åŒ—å¸‚æ¿æ©‹å€ç¸£æ°‘å¤§é“äºŒæ®µ7è™Ÿ', phone: '02-2960-1235', lat: 25.0138, lng: 121.4647 },
                    { id: 'NB003', name: '7-ELEVEN åºœä¸­é–€å¸‚', address: 'æ–°åŒ—å¸‚æ¿æ©‹å€åºœä¸­è·¯15è™Ÿ', phone: '02-2960-1236', lat: 25.0108, lng: 121.4607 }
                ],
                'ä¸­å’Œå€': [
                    { id: 'NB004', name: '7-ELEVEN ä¸­å’Œé–€å¸‚', address: 'æ–°åŒ—å¸‚ä¸­å’Œå€ä¸­å’Œè·¯234è™Ÿ', phone: '02-2940-2345', lat: 24.9988, lng: 121.4967 },
                    { id: 'NB005', name: '7-ELEVEN æ™¯å®‰é–€å¸‚', address: 'æ–°åŒ—å¸‚ä¸­å’Œå€æ™¯å¹³è·¯567è™Ÿ', phone: '02-2940-2346', lat: 24.9978, lng: 121.4977 },
                    { id: 'NB006', name: '7-ELEVEN å—å‹¢è§’é–€å¸‚', address: 'æ–°åŒ—å¸‚ä¸­å’Œå€å—å±±è·¯890è™Ÿ', phone: '02-2940-2347', lat: 24.9968, lng: 121.4987 }
                ]
            },
            'æ¡ƒåœ’å¸‚': {
                'æ¡ƒåœ’å€': [
                    { id: 'TY001', name: '7-ELEVEN æ¡ƒåœ’é–€å¸‚', address: 'æ¡ƒåœ’å¸‚æ¡ƒåœ’å€ä¸­æ­£è·¯345è™Ÿ', phone: '03-333-4567', lat: 24.9936, lng: 121.3010 },
                    { id: 'TY002', name: '7-ELEVEN ç«è»Šç«™é–€å¸‚', address: 'æ¡ƒåœ’å¸‚æ¡ƒåœ’å€å¾©èˆˆè·¯123è™Ÿ', phone: '03-333-4568', lat: 24.9896, lng: 121.3130 },
                    { id: 'TY003', name: '7-ELEVEN è—æ–‡é–€å¸‚', address: 'æ¡ƒåœ’å¸‚æ¡ƒåœ’å€åŒå¾·è·¯456è™Ÿ', phone: '03-333-4569', lat: 24.9916, lng: 121.3050 }
                ]
            },
            'å°ä¸­å¸‚': {
                'ä¸­å€': [
                    { id: 'TC001', name: '7-ELEVEN å°ä¸­é–€å¸‚', address: 'å°ä¸­å¸‚ä¸­å€å°ç£å¤§é“ä¸€æ®µ456è™Ÿ', phone: '04-2220-3456', lat: 24.1477, lng: 120.6736 },
                    { id: 'TC002', name: '7-ELEVEN ç«è»Šç«™é–€å¸‚', address: 'å°ä¸­å¸‚ä¸­å€å»ºåœ‹è·¯123è™Ÿ', phone: '04-2220-3457', lat: 24.1367, lng: 120.6856 },
                    { id: 'TC003', name: '7-ELEVEN ä¸€ä¸­é–€å¸‚', address: 'å°ä¸­å¸‚ä¸­å€ä¸‰æ°‘è·¯789è™Ÿ', phone: '04-2220-3458', lat: 24.1547, lng: 120.6816 }
                ]
            },
            'é«˜é›„å¸‚': {
                'å‰é‡‘å€': [
                    { id: 'KH001', name: '7-ELEVEN é«˜é›„é–€å¸‚', address: 'é«˜é›„å¸‚å‰é‡‘å€ä¸­æ­£å››è·¯567è™Ÿ', phone: '07-201-2345', lat: 22.6273, lng: 120.3014 },
                    { id: 'KH002', name: '7-ELEVEN ä¸­å¤®å…¬åœ’é–€å¸‚', address: 'é«˜é›„å¸‚å‰é‡‘å€äº”ç¦ä¸‰è·¯123è™Ÿ', phone: '07-201-2346', lat: 22.6293, lng: 120.3034 },
                    { id: 'KH003', name: '7-ELEVEN æ„›æ²³é–€å¸‚', address: 'é«˜é›„å¸‚å‰é‡‘å€æ²³æ±è·¯234è™Ÿ', phone: '07-201-2347', lat: 22.6313, lng: 120.3054 }
                ]
            }
        };

        // å…¨åŸŸè®Šæ•¸ï¼šå…¨å®¶ä¾¿åˆ©å•†åº—é–€å¸‚è³‡æ–™åº«
        const familyMartStores = {
            'å°åŒ—å¸‚': {
                'ä¸­æ­£å€': [
                    { id: 'FM001', name: 'å…¨å®¶ ä¸­æ­£åº—', address: 'å°åŒ—å¸‚ä¸­æ­£å€é‡æ…¶å—è·¯ä¸€æ®µ122è™Ÿ', phone: '02-2345-6789', lat: 25.0330, lng: 121.5654 },
                    { id: 'FM002', name: 'å…¨å®¶ å°åŒ—è»Šç«™åº—', address: 'å°åŒ—å¸‚ä¸­æ­£å€åŒ—å¹³è¥¿è·¯3è™ŸB1', phone: '02-2345-6790', lat: 25.0478, lng: 121.5170 },
                    { id: 'FM003', name: 'å…¨å®¶ è¥¿é–€åº—', address: 'å°åŒ—å¸‚ä¸­æ­£å€å³¨åµ‹è¡—52è™Ÿ', phone: '02-2345-6791', lat: 25.0419, lng: 121.5070 }
                ],
                'å¤§å®‰å€': [
                    { id: 'FM004', name: 'å…¨å®¶ å¿ å­åº—', address: 'å°åŒ—å¸‚å¤§å®‰å€å¿ å­æ±è·¯å››æ®µ216å··8è™Ÿ', phone: '02-2345-6792', lat: 25.0415, lng: 121.5440 },
                    { id: 'FM005', name: 'å…¨å®¶ æ•¦å—åº—', address: 'å°åŒ—å¸‚å¤§å®‰å€æ•¦åŒ–å—è·¯ä¸€æ®µ187å··3è™Ÿ', phone: '02-2345-6793', lat: 25.0400, lng: 121.5500 },
                    { id: 'FM006', name: 'å…¨å®¶ æ±å€åº—', address: 'å°åŒ—å¸‚å¤§å®‰å€å¤§å®‰è·¯ä¸€æ®µ51å··15è™Ÿ', phone: '02-2345-6794', lat: 25.0380, lng: 121.5380 }
                ]
            },
            'æ–°åŒ—å¸‚': {
                'æ¿æ©‹å€': [
                    { id: 'FM007', name: 'å…¨å®¶ æ¿æ©‹åº—', address: 'æ–°åŒ—å¸‚æ¿æ©‹å€ä¸­å±±è·¯ä¸€æ®µ50è™Ÿ', phone: '02-2960-1234', lat: 25.0118, lng: 121.4627 },
                    { id: 'FM008', name: 'å…¨å®¶ æ–°æ¿åº—', address: 'æ–°åŒ—å¸‚æ¿æ©‹å€ç¸£æ°‘å¤§é“äºŒæ®µ68è™Ÿ', phone: '02-2960-1235', lat: 25.0138, lng: 121.4647 }
                ]
            },
            'å°ä¸­å¸‚': {
                'ä¸­å€': [
                    { id: 'FM009', name: 'å…¨å®¶ å°ä¸­åº—', address: 'å°ä¸­å¸‚ä¸­å€å°ç£å¤§é“ä¸€æ®µ57è™Ÿ', phone: '04-2220-3456', lat: 24.1477, lng: 120.6736 },
                    { id: 'FM010', name: 'å…¨å®¶ ä¸€ä¸­åº—', address: 'å°ä¸­å¸‚ä¸­å€ä¸€ä¸­è¡—127è™Ÿ', phone: '04-2220-3457', lat: 24.1547, lng: 120.6816 }
                ]
            }
        };

        // å°ç£ç¸£å¸‚è³‡æ–™
        const taiwanData = {
            'å°åŒ—å¸‚': ['ä¸­æ­£å€', 'å¤§åŒå€', 'ä¸­å±±å€', 'æ¾å±±å€', 'å¤§å®‰å€', 'è¬è¯å€', 'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'å—æ¸¯å€', 'æ–‡å±±å€'],
            'æ–°åŒ—å¸‚': ['æ¿æ©‹å€', 'ä¸‰é‡å€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'æ–°èŠå€', 'æ–°åº—å€', 'æ¨¹æ—å€', 'é¶¯æ­Œå€', 'ä¸‰å³½å€', 'æ·¡æ°´å€', 'æ±æ­¢å€', 'ç‘èŠ³å€', 'åœŸåŸå€', 'è˜†æ´²å€', 'äº”è‚¡å€', 'æ³°å±±å€', 'æ—å£å€', 'æ·±å‘å€', 'çŸ³ç¢‡å€', 'åªæ—å€', 'ä¸‰èŠå€', 'çŸ³é–€å€', 'å…«é‡Œå€', 'å¹³æºªå€', 'é›™æºªå€', 'è²¢å¯®å€', 'é‡‘å±±å€', 'è¬é‡Œå€', 'çƒä¾†å€'],
            'æ¡ƒåœ’å¸‚': ['æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¤§æºªå€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§åœ’å€', 'é¾œå±±å€', 'å…«å¾·å€', 'é¾æ½­å€', 'å¹³é®å€', 'æ–°å±‹å€', 'è§€éŸ³å€', 'å¾©èˆˆå€'],
            'å°ä¸­å¸‚': ['ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'åé‡Œå€', 'çŸ³å²¡å€', 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'æ½­å­å€', 'å¤§é›…å€', 'ç¥å²¡å€', 'å¤§è‚šå€', 'æ²™é¹¿å€', 'é¾äº•å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'å¤§å®‰å€'],
            'å°å—å¸‚': ['ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'å·¦é®å€', 'ç‰äº•å€', 'æ¥ è¥¿å€', 'å—åŒ–å€', 'ä»å¾·å€', 'é—œå»Ÿå€', 'é¾å´å€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'è¥¿æ¸¯å€', 'ä¸ƒè‚¡å€', 'å°‡è»å€', 'å­¸ç”²å€', 'åŒ—é–€å€', 'æ–°ç‡Ÿå€', 'å¾Œå£å€', 'ç™½æ²³å€', 'æ±å±±å€', 'å…­ç”²å€', 'ä¸‹ç‡Ÿå€', 'æŸ³ç‡Ÿå€', 'é¹½æ°´å€', 'å–„åŒ–å€', 'å¤§å…§å€', 'å±±ä¸Šå€', 'æ–°å¸‚å€', 'å®‰å®šå€'],
            'é«˜é›„å¸‚': ['æ–°èˆˆå€', 'å‰é‡‘å€', 'è‹“é›…å€', 'é¹½åŸ•å€', 'é¼“å±±å€', 'æ——æ´¥å€', 'å‰é®å€', 'ä¸‰æ°‘å€', 'æ¥ æ¢“å€', 'å°æ¸¯å€', 'å·¦ç‡Ÿå€', 'ä»æ­¦å€', 'å¤§ç¤¾å€', 'å²¡å±±å€', 'è·¯ç«¹å€', 'é˜¿è“®å€', 'ç”°å¯®å€', 'ç‡•å·¢å€', 'æ©‹é ­å€', 'æ¢“å®˜å€', 'å½Œé™€å€', 'æ°¸å®‰å€', 'æ¹–å…§å€', 'é³³å±±å€', 'å¤§å¯®å€', 'æ—åœ’å€', 'é³¥æ¾å€', 'å¤§æ¨¹å€', 'æ——å±±å€', 'ç¾æ¿ƒå€', 'å…­é¾œå€', 'å…§é–€å€', 'æ‰æ—å€', 'ç”²ä»™å€', 'æ¡ƒæºå€', 'é‚£ç‘ªå¤å€', 'èŒ‚æ—å€', 'èŒ„è£å€']
        };

        class StoreSelector {
            constructor() {
                // åœ¨Netlifyä¸Šä¸éœ€è¦ç›´æ¥å­˜å–APIé‡‘é‘°ï¼Œé€éFunctionså‘¼å«
                this.apiKey = null;  // é€éNetlify Functionså­˜å–
                this.map = null;
                this.markers = [];
                this.selectedStore = null;
                this.stores = [];
                
                this.initializeElements();
                this.loadCities();
                this.initializeMap();
                this.bindEvents();
            }

            initializeElements() {
                this.storeTypeSelect = document.getElementById('storeTypeSelect');
                this.citySelect = document.getElementById('citySelect');
                this.districtSelect = document.getElementById('districtSelect');
                this.storeList = document.getElementById('storeList');
                this.confirmBtn = document.getElementById('confirmBtn');
                this.selectedInfo = document.getElementById('selectedInfo');
            }

            loadCities() {
                Object.keys(taiwanData).forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    this.citySelect.appendChild(option);
                });
            }

            bindEvents() {
                this.storeTypeSelect.addEventListener('change', () => this.onStoreTypeChange());
                this.citySelect.addEventListener('change', () => this.onCityChange());
                this.districtSelect.addEventListener('change', () => this.onDistrictChange());
                this.confirmBtn.addEventListener('click', () => this.confirmSelection());
            }

            onStoreTypeChange() {
                // é‡ç½®é¸æ“‡
                this.citySelect.value = '';
                this.districtSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ç¸£å¸‚</option>';
                this.districtSelect.disabled = true;
                this.clearStoreList();
                
                // æ›´æ–°æ¨™é¡Œ
                const storeType = this.storeTypeSelect.value;
                const storeTypeName = storeType === 'family' ? 'å…¨å®¶ä¾¿åˆ©å•†åº—' : '7-ELEVEN';
                document.querySelector('.header h1').textContent = `ğŸª é¸æ“‡ ${storeTypeName} å–è²¨é–€å¸‚`;
            }

            onCityChange() {
                const selectedCity = this.citySelect.value;
                this.districtSelect.innerHTML = '<option value="">è«‹é¸æ“‡å€åŸŸ</option>';
                this.districtSelect.disabled = !selectedCity;
                
                if (selectedCity && taiwanData[selectedCity]) {
                    taiwanData[selectedCity].forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        this.districtSelect.appendChild(option);
                    });
                    this.districtSelect.disabled = false;
                }
                
                this.clearStoreList();
            }

            onDistrictChange() {
                const city = this.citySelect.value;
                const district = this.districtSelect.value;
                
                if (city && district) {
                    this.searchStores(city, district);
                } else {
                    this.clearStoreList();
                }
            }

            async searchStores(city, district) {
                this.storeList.innerHTML = '<div class="loading">æœå°‹é–€å¸‚ä¸­...</div>';
                
                const storeType = this.storeTypeSelect.value;
                let useLocalData = false;
                
                try {
                    console.log(`æœå°‹é–€å¸‚: ${city} ${district} (${storeType})`);
                    
                    // é¦–å…ˆå˜—è©¦ä½¿ç”¨Netlify Functionså‘¼å«Google Places API
                    const response = await fetch(`/.netlify/functions/search-stores?city=${encodeURIComponent(city)}&district=${encodeURIComponent(district)}&storeType=${storeType}`, {
                        timeout: 10000 // 10ç§’è¶…æ™‚
                    });
                    
                    if (!response.ok) {
                        console.warn(`APIè«‹æ±‚å¤±æ•— (${response.status}), ä½¿ç”¨æœ¬åœ°è³‡æ–™`);
                        useLocalData = true;
                    } else {
                        const data = await response.json();
                        console.log('APIå›å‚³è³‡æ–™:', data);
                        
                        if (data.success && data.stores && data.stores.length > 0) {
                            // è½‰æ›APIå›å‚³æ ¼å¼ç‚ºå‰ç«¯éœ€è¦çš„æ ¼å¼
                            const formattedStores = data.stores.map(store => ({
                                name: store.storeName,
                                formatted_address: store.storeAddress,
                                place_id: store.storeId,
                                geometry: {
                                    location: store.location
                                },
                                rating: store.rating,
                                opening_hours: {
                                    open_now: store.openNow
                                }
                            }));
                            
                            console.log(`æ‰¾åˆ° ${formattedStores.length} å€‹Google APIé–€å¸‚`);
                            this.displayStores(formattedStores);
                            return;
                        } else {
                            console.log('Google APIç„¡çµæœï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
                            useLocalData = true;
                        }
                    }
                    
                } catch (error) {
                    console.error('æœå°‹é–€å¸‚éŒ¯èª¤:', error);
                    useLocalData = true;
                }
                
                // ä½¿ç”¨æœ¬åœ°è³‡æ–™åº«ä½œç‚ºå‚™æ´
                if (useLocalData) {
                    console.log('ä½¿ç”¨æœ¬åœ°é–€å¸‚è³‡æ–™ä½œç‚ºå‚™æ´');
                    const localStores = this.getLocalStores(city, district, storeType);
                    console.log(`æ‰¾åˆ° ${localStores.length} å€‹æœ¬åœ°é–€å¸‚`);
                    
                    if (localStores.length > 0) {
                        this.displayStores(localStores);
                    } else {
                        // å¦‚æœæœ¬åœ°ä¹Ÿæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                        const storeTypeName = storeType === 'family' ? 'å…¨å®¶ä¾¿åˆ©å•†åº—' : '7-ELEVEN';
                        this.storeList.innerHTML = `
                            <div class="loading" style="text-align: center; padding: 20px;">
                                <p>ğŸ˜… æ­¤å€åŸŸæš«ç„¡${storeTypeName}é–€å¸‚è³‡æ–™</p>
                                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                                    è«‹å˜—è©¦é¸æ“‡å…¶ä»–å€åŸŸï¼Œæˆ–ç¨å¾Œå†è©¦
                                </p>
                            </div>
                        `;
                    }
                }
            }

            getLocalStores(city, district, storeType = '711') {
                console.log(`å–å¾—æœ¬åœ°é–€å¸‚è³‡æ–™: ${city} ${district} ${storeType}`);
                
                let storeDatabase;
                
                // æ ¹æ“šé–€å¸‚é¡å‹é¸æ“‡è³‡æ–™åº«
                if (storeType === 'family') {
                    storeDatabase = familyMartStores;
                } else {
                    storeDatabase = sevenElevenStores;
                }
                
                console.log('å¯ç”¨åŸå¸‚:', Object.keys(storeDatabase));
                
                // å¾æœ¬åœ°è³‡æ–™åº«ç²å–é–€å¸‚è³‡æ–™ï¼ˆä½œç‚ºå‚™æ´ï¼‰
                if (storeDatabase[city]) {
                    console.log(`${city}å¯ç”¨å€åŸŸ:`, Object.keys(storeDatabase[city]));
                    
                    if (storeDatabase[city][district]) {
                        const stores = storeDatabase[city][district].map(store => ({
                            name: store.name,
                            address: store.address,
                            phone: store.phone,
                            geometry: {
                                location: { lat: store.lat, lng: store.lng }
                            },
                            place_id: store.id,
                            formatted_address: store.address
                        }));
                        
                        console.log(`æœ¬åœ°è³‡æ–™åº«æ‰¾åˆ° ${stores.length} å€‹é–€å¸‚`);
                        return stores;
                    } else {
                        console.log(`${city}æ²’æœ‰${district}çš„é–€å¸‚è³‡æ–™`);
                    }
                } else {
                    console.log(`æ²’æœ‰${city}çš„é–€å¸‚è³‡æ–™`);
                }
                
                // å¦‚æœæ²’æœ‰æœ¬åœ°è³‡æ–™ï¼Œè¿”å›ç©ºé™£åˆ—
                return [];
            }

            displayStores(stores) {
                const storeType = this.storeTypeSelect.value;
                
                // æ ¹æ“šé–€å¸‚é¡å‹éæ¿¾é–€å¸‚
                if (storeType === 'family') {
                    this.stores = stores.filter(store => 
                        store.name.includes('å…¨å®¶') || 
                        store.name.includes('FamilyMart') ||
                        store.name.includes('Family')
                    );
                } else {
                    this.stores = stores.filter(store => 
                        store.name.includes('7-ELEVEN') || 
                        store.name.includes('7-11') ||
                        store.name.includes('çµ±ä¸€è¶…å•†')
                    );
                }

                if (this.stores.length === 0) {
                    const storeTypeName = storeType === 'family' ? 'å…¨å®¶ä¾¿åˆ©å•†åº—' : '7-ELEVEN';
                    this.storeList.innerHTML = `<div class="loading">æ­¤å€åŸŸæš«ç„¡${storeTypeName}é–€å¸‚è³‡æ–™</div>`;
                    return;
                }

                this.storeList.innerHTML = '';
                this.stores.forEach((store, index) => {
                    const storeItem = document.createElement('div');
                    storeItem.className = 'store-item';
                    storeItem.dataset.index = index;
                    
                    storeItem.innerHTML = `
                        <div class="store-name">${store.name}</div>
                        <div class="store-address">${store.formatted_address || store.address}</div>
                    `;
                    
                    storeItem.addEventListener('click', () => this.selectStore(index));
                    this.storeList.appendChild(storeItem);
                });

                this.updateMapMarkers();
            }

            selectStore(index) {
                // ç§»é™¤ä¹‹å‰çš„é¸æ“‡
                document.querySelectorAll('.store-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // é¸æ“‡æ–°çš„é–€å¸‚
                const storeItem = document.querySelector(`[data-index="${index}"]`);
                storeItem.classList.add('selected');
                
                this.selectedStore = this.stores[index];
                this.confirmBtn.disabled = false;
                
                // æ›´æ–°åœ°åœ–ä¸­å¿ƒå’Œè³‡è¨Š
                this.showStoreOnMap(this.selectedStore);
                this.showSelectedInfo(this.selectedStore);
            }

            showStoreOnMap(store) {
                if (this.map && store.geometry && window.google) {
                    const location = store.geometry.location;
                    this.map.setCenter(location);
                    this.map.setZoom(16);
                    
                    // é«˜äº®é¸ä¸­çš„æ¨™è¨˜
                    this.markers.forEach(marker => {
                        marker.setIcon({
                            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                        });
                    });
                    
                    const selectedMarker = this.markers.find(marker => 
                        marker.getPosition().lat() === location.lat &&
                        marker.getPosition().lng() === location.lng
                    );
                    
                    if (selectedMarker) {
                        selectedMarker.setIcon({
                            url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                        });
                    }
                } else {
                    // å¦‚æœåœ°åœ–æœªè¼‰å…¥ï¼Œé¡¯ç¤ºé–€å¸‚è³‡è¨Š
                    this.showStoreInfoInMapPanel(store);
                }
            }

            showStoreInfoInMapPanel(store) {
                const mapElement = document.getElementById('map');
                mapElement.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; flex-direction: column; text-align: center; padding: 40px;">
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 100%;">
                            <div style="font-size: 3em; margin-bottom: 20px;">ğŸª</div>
                            <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.3em;">${store.name}</h3>
                            <p style="color: #666; margin-bottom: 15px; line-height: 1.5;">${store.formatted_address || store.address}</p>
                            ${store.phone ? `<p style="color: #667eea; margin: 0; font-weight: bold;">ğŸ“ ${store.phone}</p>` : ''}
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef; color: #999; font-size: 0.9em;">
                                å·²é¸æ“‡çš„é–€å¸‚
                            </div>
                        </div>
                    </div>
                `;
            }

            showSelectedInfo(store) {
                document.getElementById('selectedStoreName').textContent = store.name;
                document.getElementById('selectedStoreAddress').textContent = store.formatted_address || store.address;
                document.getElementById('selectedStorePhone').textContent = store.phone || 'é›»è©±è³‡è¨Šå¾…æ›´æ–°';
                this.selectedInfo.classList.add('show');
            }

            updateMapMarkers() {
                // æ¸…é™¤èˆŠæ¨™è¨˜
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];
                
                if (!this.map) return;
                
                // æ·»åŠ æ–°æ¨™è¨˜
                this.stores.forEach(store => {
                    if (store.geometry) {
                        const marker = new google.maps.Marker({
                            position: store.geometry.location,
                            map: this.map,
                            title: store.name,
                            icon: {
                                url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                            }
                        });
                        
                        this.markers.push(marker);
                    }
                });
                
                // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
                if (this.markers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    this.markers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    this.map.fitBounds(bounds);
                }
            }

            clearStoreList() {
                this.storeList.innerHTML = '<div class="loading">è«‹å…ˆé¸æ“‡é–€å¸‚é¡å‹ã€ç¸£å¸‚å’Œå€åŸŸ</div>';
                this.confirmBtn.disabled = true;
                this.selectedStore = null;
                this.selectedInfo.classList.remove('show');
                
                // æ¸…é™¤åœ°åœ–æ¨™è¨˜
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];
            }

            async initializeMap() {
                try {
                    // é€éNetlify Functionå–å¾—APIé‡‘é‘°ä¸¦è¼‰å…¥åœ°åœ–
                    const response = await fetch('/.netlify/functions/get-map-config');
                    const config = await response.json();
                    
                    if (config.success && config.apiKey) {
                        this.loadGoogleMaps(config.apiKey);
                    } else {
                        throw new Error('ç„¡æ³•å–å¾—åœ°åœ–é…ç½®');
                    }
                } catch (error) {
                    console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
                    // ä½¿ç”¨æœ¬åœ°åœ°åœ–æ›¿ä»£æ–¹æ¡ˆ
                    this.showLocalMapAlternative();
                }
            }

            loadGoogleMaps(apiKey) {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&language=zh-TW`;
                script.async = true;
                script.onerror = () => {
                    console.error('Google Mapsè¼‰å…¥å¤±æ•—');
                    this.showLocalMapAlternative();
                };
                document.head.appendChild(script);
                
                window.initMap = () => {
                    this.map = new google.maps.Map(document.getElementById('map'), {
                        center: { lat: 23.8, lng: 121.0 }, // å°ç£ä¸­å¿ƒ
                        zoom: 7,
                        styles: [
                            {
                                featureType: 'poi',
                                elementType: 'labels',
                                stylers: [{ visibility: 'off' }]
                            }
                        ]
                    });
                };
            }

            showLocalMapAlternative() {
                const mapElement = document.getElementById('map');
                mapElement.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; flex-direction: column; text-align: center; padding: 40px;">
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 100%;">
                            <div style="font-size: 4em; margin-bottom: 20px;">ğŸ—ºï¸</div>
                            <h3 style="color: #666; margin-bottom: 15px;">åœ°åœ–æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨</h3>
                            <p style="color: #999; margin-bottom: 20px;">é¸æ“‡é–€å¸‚å¾Œå°‡åœ¨æ­¤é¡¯ç¤ºè©³ç´°è³‡è¨Š</p>
                            <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 10px; color: #1976d2; font-size: 0.9em;">
                                ğŸ’¡ æç¤ºï¼šé–€å¸‚åŠŸèƒ½æ­£å¸¸é‹ä½œï¼Œåœ°åœ–é¡¯ç¤ºä¸å½±éŸ¿é¸æ“‡
                            </div>
                        </div>
                    </div>
                `;
            }

            confirmSelection() {
                if (!this.selectedStore) return;
                
                // å„²å­˜é¸æ“‡çš„é–€å¸‚åˆ°è³¼ç‰©è»Š
                const storeData = {
                    storeId: this.selectedStore.place_id,
                    storeName: this.selectedStore.name,
                    storeAddress: this.selectedStore.formatted_address || this.selectedStore.address,
                    storePhone: this.selectedStore.phone,
                    location: this.selectedStore.geometry?.location
                };
                
                // ç”Ÿæˆè¨‚å–®
                this.generateOrder(storeData);
            }

            async generateOrder(storeData) {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                this.confirmBtn.disabled = true;
                this.confirmBtn.textContent = 'ç”Ÿæˆè¨‚å–®ä¸­...';
                
                // æ¨¡æ“¬è¼‰å…¥æ™‚é–“
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // ç”Ÿæˆè¨‚å–®è™Ÿç¢¼ï¼ˆä½¿ç”¨æ™‚é–“æˆ³ç¢ºä¿å”¯ä¸€æ€§ï¼‰
                const orderNumber = 'ORD' + Date.now();
                
                // å„²å­˜è¨‚å–®è³‡æ–™åˆ°localStorage
                const orderData = {
                    id: orderNumber,
                    selectedStore: storeData,
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                };
                
                // ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
                localStorage.setItem('currentOrder', JSON.stringify(orderData));
                localStorage.setItem('selectedStore', JSON.stringify(storeData));
                
                // é¡¯ç¤ºè¨‚å–®è³‡è¨Š
                this.showOrderInfo(orderData);
            }

            showOrderInfo(order) {
                // æª¢æŸ¥æ˜¯å¦æ˜¯å¾è³¼ç‰©è»Šé é¢å‘¼å«çš„
                const urlParams = new URLSearchParams(window.location.search);
                const fromCart = urlParams.get('from') === 'cart';
                
                if (fromCart) {
                    // è¿”å›è³¼ç‰©è»Šä¸¦å‚³éé–€å¸‚è³‡è¨Š
                    this.returnToCart(order.selectedStore);
                    return;
                }
                
                // éš±è—ç¢ºèªæŒ‰éˆ•
                this.confirmBtn.style.display = 'none';
                
                // é¡¯ç¤ºè¨‚å–®æ­¥é©Ÿ
                const orderStep = document.getElementById('orderStep');
                const orderNumber = document.getElementById('orderNumber');
                
                orderNumber.textContent = order.id;
                orderStep.style.display = 'block';
                orderStep.classList.add('success-animation');
                
                // æ›´æ–°æ¨™é¡Œ
                document.querySelector('.header h1').textContent = 'ğŸ‰ è¨‚å–®ç”ŸæˆæˆåŠŸ';
                document.querySelector('.header p').textContent = 'è«‹å°‡è¨‚å–®è™Ÿç¢¼æä¾›çµ¦å®¢æœç¢ºèªè¨‚å–®';
            }

            returnToCart(storeData) {
                // å°‡é–€å¸‚è³‡è¨Šå„²å­˜åˆ°localStorage
                localStorage.setItem('selectedStoreData', JSON.stringify({
                    storeType: this.getStoreType(storeData.storeName),
                    storeId: this.extractStoreId(storeData.storeName, storeData.storeAddress),
                    storeName: this.cleanStoreName(storeData.storeName),
                    storeAddress: storeData.storeAddress,
                    timestamp: Date.now()
                }));
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                alert('âœ… é–€å¸‚é¸æ“‡å®Œæˆï¼\næ­£åœ¨è¿”å›è³¼ç‰©è»Šé é¢...');
                
                // è¿”å›è³¼ç‰©è»Šé é¢
                window.location.href = 'cart.html';
            }

            getStoreType(storeName) {
                if (storeName.includes('7-ELEVEN') || storeName.includes('7-11') || storeName.includes('çµ±ä¸€è¶…å•†')) {
                    return '711';
                } else if (storeName.includes('å…¨å®¶') || storeName.includes('FamilyMart')) {
                    return 'family';
                }
                return '711'; // é è¨­ç‚º7-ELEVEN
            }

            extractStoreId(storeName, storeAddress) {
                // å˜—è©¦å¾é–€å¸‚åç¨±ä¸­æå–åº—è™Ÿ
                const nameMatch = storeName.match(/\d{4,6}/);
                if (nameMatch) {
                    return nameMatch[0];
                }
                
                // å˜—è©¦å¾åœ°å€ä¸­æå–åº—è™Ÿ
                const addressMatch = storeAddress.match(/\d{4,6}/);
                if (addressMatch) {
                    return addressMatch[0];
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œç”Ÿæˆä¸€å€‹åŸºæ–¼æ™‚é–“çš„åº—è™Ÿ
                return Date.now().toString().slice(-6);
            }

            cleanStoreName(storeName) {
                // ç§»é™¤å¸¸è¦‹çš„å‰ç¶´å’Œåº—è™Ÿï¼Œåªä¿ç•™é–€å¸‚åç¨±
                return storeName
                    .replace(/7-ELEVEN\s*/i, '')
                    .replace(/7-11\s*/i, '')
                    .replace(/çµ±ä¸€è¶…å•†\s*/i, '')
                    .replace(/å…¨å®¶\s*/i, '')
                    .replace(/FamilyMart\s*/i, '')
                    .replace(/\d{4,6}\s*/, '') // ç§»é™¤åº—è™Ÿ
                    .replace(/é–€å¸‚\s*$/, '') // ç§»é™¤çµå°¾çš„"é–€å¸‚"
                    .trim();
            }

            async saveToCart(storeData) {
                try {
                    // é€™è£¡ä¸²æ¥ä½ çš„è³¼ç‰©è»ŠAPI
                    const response = await fetch('/api/cart/store', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            selectedStore: storeData,
                            cartId: this.getCartId() // å–å¾—è³¼ç‰©è»ŠID
                        })
                    });
                    
                    if (response.ok) {
                        console.log('é–€å¸‚è³‡è¨Šå·²å„²å­˜è‡³è³¼ç‰©è»Š');
                        // å¯ä»¥å°å‘çµå¸³é é¢
                        // window.location.href = '/checkout';
                    }
                } catch (error) {
                    console.error('å„²å­˜é–€å¸‚è³‡è¨Šå¤±æ•—:', error);
                }
            }

            getCartId() {
                // å¾localStorageæˆ–cookieå–å¾—è³¼ç‰©è»ŠID
                return localStorage.getItem('cartId') || 'temp_cart_id';
            }

            // æ¸¬è©¦æœ¬åœ°è³‡æ–™åŠŸèƒ½
            testLocalData() {
                console.log('=== æ¸¬è©¦æœ¬åœ°è³‡æ–™ ===');
                
                // æ¸¬è©¦sevenElevenStores
                console.log('7-ELEVENè³‡æ–™åº«:', sevenElevenStores);
                console.log('å…¨å®¶è³‡æ–™åº«:', familyMartStores);
                
                // æ¸¬è©¦å°åŒ—å¸‚ä¸­æ­£å€7-ELEVEN
                const test711 = this.getLocalStores('å°åŒ—å¸‚', 'ä¸­æ­£å€', '711');
                console.log('æ¸¬è©¦å°åŒ—å¸‚ä¸­æ­£å€7-ELEVEN:', test711);
                
                // æ¸¬è©¦å°åŒ—å¸‚ä¸­æ­£å€å…¨å®¶
                const testFamily = this.getLocalStores('å°åŒ—å¸‚', 'ä¸­æ­£å€', 'family');
                console.log('æ¸¬è©¦å°åŒ—å¸‚ä¸­æ­£å€å…¨å®¶:', testFamily);
                
                // è‡ªå‹•é¸æ“‡å°åŒ—å¸‚ä¸­æ­£å€é€²è¡Œæ¸¬è©¦
                this.citySelect.value = 'å°åŒ—å¸‚';
                this.onCityChange();
                
                setTimeout(() => {
                    this.districtSelect.value = 'ä¸­æ­£å€';
                    this.onDistrictChange();
                }, 100);
                
                alert('æ¸¬è©¦å®Œæˆï¼Œè«‹æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å° (F12) çš„Console');
            }
        }

        // è¤‡è£½è¨‚å–®è™Ÿç¢¼åŠŸèƒ½
        function copyOrderNumber() {
            const orderNumber = document.getElementById('orderNumber').textContent;
            const copyBtn = document.getElementById('copyBtn');
            
            // ä½¿ç”¨ç¾ä»£çš„Clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(orderNumber).then(() => {
                    showCopySuccess(copyBtn);
                }).catch(() => {
                    fallbackCopy(orderNumber, copyBtn);
                });
            } else {
                fallbackCopy(orderNumber, copyBtn);
            }
        }

        // å‚™ç”¨è¤‡è£½æ–¹æ³•
        function fallbackCopy(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½è¨‚å–®è™Ÿç¢¼');
            }
            
            document.body.removeChild(textArea);
        }

        // é¡¯ç¤ºè¤‡è£½æˆåŠŸç‹€æ…‹
        function showCopySuccess(button) {
            const originalText = button.textContent;
            button.textContent = 'âœ… å·²è¤‡è£½';
            button.classList.add('copied');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('copied');
            }, 2000);
        }

        // åˆå§‹åŒ–é–€å¸‚é¸æ“‡å™¨
        let storeSelector;
        document.addEventListener('DOMContentLoaded', () => {
            storeSelector = new StoreSelector();
        });
    </script>
</body>
</html> 