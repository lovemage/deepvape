<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        .test-btn:hover {
            background: #0056b3;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #e7f3ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ APIè¨ºæ–·å·¥å…·</h1>
            <p>è¨ºæ–·Google Places APIçš„å„ç¨®å•é¡Œ</p>
        </div>

        <!-- APIé‡‘é‘°æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ”‘ APIé‡‘é‘°åŸºæœ¬æ¸¬è©¦</h3>
            <button onclick="testApiKeyBasic()" class="test-btn">æ¸¬è©¦APIé‡‘é‘°è¼‰å…¥</button>
            <div id="apiKeyBasicResults" class="results"></div>
        </div>

        <!-- èˆŠç‰ˆAPIæ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ›ï¸ èˆŠç‰ˆPlaces APIæ¸¬è©¦</h3>
            <button onclick="testLegacyAPI()" class="test-btn">æ¸¬è©¦èˆŠç‰ˆAPI</button>
            <div id="legacyResults" class="results"></div>
        </div>

        <!-- æ–°ç‰ˆAPIæ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ†• æ–°ç‰ˆPlaces APIæ¸¬è©¦</h3>
            <button onclick="testNewAPI()" class="test-btn">æ¸¬è©¦æ–°ç‰ˆAPI</button>
            <div id="newResults" class="results"></div>
        </div>

        <!-- Maps JavaScript APIæ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ—ºï¸ Maps JavaScript APIæ¸¬è©¦</h3>
            <button onclick="testMapsAPI()" class="test-btn">æ¸¬è©¦Maps API</button>
            <div id="mapsResults" class="results"></div>
        </div>

        <!-- è©³ç´°éŒ¯èª¤åˆ†æ -->
        <div class="test-section">
            <h3>ğŸ” è©³ç´°éŒ¯èª¤åˆ†æ</h3>
            <button onclick="analyzeError()" class="test-btn">åˆ†æ403éŒ¯èª¤</button>
            <div id="errorAnalysis" class="results"></div>
        </div>

        <!-- APIæœå‹™ç‹€æ…‹æª¢æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ“Š APIæœå‹™ç‹€æ…‹</h3>
            <button onclick="checkServiceStatus()" class="test-btn">æª¢æŸ¥æœå‹™ç‹€æ…‹</button>
            <div id="serviceStatus" class="results"></div>
        </div>
    </div>

    <script>
        let apiKey = '';

        // åˆå§‹åŒ–
        async function initializeAPI() {
            try {
                const response = await fetch('/.netlify/functions/get-map-config');
                const config = await response.json();
                
                if (config.success && config.apiKey) {
                    apiKey = config.apiKey;
                    console.log('âœ… APIé‡‘é‘°å·²è¼‰å…¥:', apiKey.substring(0, 10) + '...');
                } else {
                    throw new Error('ç„¡æ³•å–å¾—APIé‡‘é‘°');
                }
            } catch (error) {
                console.error('âŒ APIåˆå§‹åŒ–å¤±æ•—:', error);
                apiKey = 'FAILED_TO_LOAD';
            }
        }

        // æ¸¬è©¦APIé‡‘é‘°åŸºæœ¬åŠŸèƒ½
        async function testApiKeyBasic() {
            const resultsDiv = document.getElementById('apiKeyBasicResults');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ”„ æ¸¬è©¦APIé‡‘é‘°è¼‰å…¥...';

            try {
                await initializeAPI();
                
                if (apiKey === 'FAILED_TO_LOAD') {
                    throw new Error('APIé‡‘é‘°è¼‰å…¥å¤±æ•—');
                }

                resultsDiv.className = 'results success';
                resultsDiv.textContent = `âœ… APIé‡‘é‘°è¼‰å…¥æˆåŠŸ
é‡‘é‘°: ${apiKey.substring(0, 15)}...${apiKey.substring(apiKey.length - 5)}
é•·åº¦: ${apiKey.length} å­—å…ƒ
æ ¼å¼: ${apiKey.startsWith('AIza') ? 'æ­£ç¢º' : 'å¯èƒ½æœ‰èª¤'}`;

            } catch (error) {
                resultsDiv.className = 'results error';
                resultsDiv.textContent = `âŒ APIé‡‘é‘°æ¸¬è©¦å¤±æ•—: ${error.message}`;
            }
        }

        // æ¸¬è©¦èˆŠç‰ˆPlaces API
        async function testLegacyAPI() {
            const resultsDiv = document.getElementById('legacyResults');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ”„ æ¸¬è©¦èˆŠç‰ˆPlaces API...';

            if (!apiKey || apiKey === 'FAILED_TO_LOAD') {
                await initializeAPI();
            }

            try {
                // ä½¿ç”¨èˆŠç‰ˆAPIçš„ç°¡å–®è«‹æ±‚
                const url = `https://maps.googleapis.com/maps/api/place/findplacefromtext/json?input=å°åŒ—è»Šç«™&inputtype=textquery&fields=place_id,name&key=${apiKey}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    resultsDiv.className = 'results success';
                    resultsDiv.textContent = `âœ… èˆŠç‰ˆPlaces APIæ­£å¸¸é‹ä½œ
ç‹€æ…‹: ${data.status}
çµæœæ•¸é‡: ${data.candidates ? data.candidates.length : 0}
å›æ‡‰: ${JSON.stringify(data, null, 2)}`;
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error_message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                resultsDiv.className = 'results error';
                resultsDiv.textContent = `âŒ èˆŠç‰ˆPlaces APIæ¸¬è©¦å¤±æ•—: ${error.message}`;
            }
        }

        // æ¸¬è©¦æ–°ç‰ˆPlaces API
        async function testNewAPI() {
            const resultsDiv = document.getElementById('newResults');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ”„ æ¸¬è©¦æ–°ç‰ˆPlaces API...';

            if (!apiKey || apiKey === 'FAILED_TO_LOAD') {
                await initializeAPI();
            }

            try {
                const requestBody = {
                    textQuery: 'å°åŒ—è»Šç«™',
                    maxResultCount: 1
                };

                const response = await fetch('https://places.googleapis.com/v1/places:searchText', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Goog-Api-Key': apiKey,
                        'X-Goog-FieldMask': 'places.id,places.displayName'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    resultsDiv.className = 'results success';
                    resultsDiv.textContent = `âœ… æ–°ç‰ˆPlaces APIæ­£å¸¸é‹ä½œ
ç‹€æ…‹ç¢¼: ${response.status}
çµæœæ•¸é‡: ${data.places ? data.places.length : 0}
å›æ‡‰: ${JSON.stringify(data, null, 2)}`;
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                resultsDiv.className = 'results error';
                resultsDiv.textContent = `âŒ æ–°ç‰ˆPlaces APIæ¸¬è©¦å¤±æ•—: ${error.message}

å¯èƒ½åŸå› :
1. Places API (New) æœªå•Ÿç”¨
2. APIé‡‘é‘°æ²’æœ‰æ­£ç¢ºçš„æ¬Šé™
3. APIé‡‘é‘°é™åˆ¶è¨­å®šå•é¡Œ
4. è¨ˆè²»å¸³æˆ¶å•é¡Œ`;
            }
        }

        // æ¸¬è©¦Maps JavaScript API
        async function testMapsAPI() {
            const resultsDiv = document.getElementById('mapsResults');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ”„ æ¸¬è©¦Maps JavaScript API...';

            if (!apiKey || apiKey === 'FAILED_TO_LOAD') {
                await initializeAPI();
            }

            try {
                // æ¸¬è©¦è¼‰å…¥Maps JavaScript API
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=mapsApiCallback`;
                
                window.mapsApiCallback = function() {
                    resultsDiv.className = 'results success';
                    resultsDiv.textContent = `âœ… Maps JavaScript APIè¼‰å…¥æˆåŠŸ
Google Maps ç‰©ä»¶å¯ç”¨: ${typeof google !== 'undefined' && typeof google.maps !== 'undefined'}`;
                };

                script.onerror = function() {
                    resultsDiv.className = 'results error';
                    resultsDiv.textContent = 'âŒ Maps JavaScript APIè¼‰å…¥å¤±æ•—';
                };

                document.head.appendChild(script);

                // 5ç§’å¾Œæª¢æŸ¥æ˜¯å¦è¼‰å…¥æˆåŠŸ
                setTimeout(() => {
                    if (resultsDiv.className === 'results info') {
                        resultsDiv.className = 'results warning';
                        resultsDiv.textContent = 'âš ï¸ Maps JavaScript APIè¼‰å…¥è¶…æ™‚';
                    }
                }, 5000);

            } catch (error) {
                resultsDiv.className = 'results error';
                resultsDiv.textContent = `âŒ Maps JavaScript APIæ¸¬è©¦å¤±æ•—: ${error.message}`;
            }
        }

        // åˆ†æ403éŒ¯èª¤
        async function analyzeError() {
            const resultsDiv = document.getElementById('errorAnalysis');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ” åˆ†æ403éŒ¯èª¤åŸå› ...';

            const analysis = `
403éŒ¯èª¤ "Method doesn't allow unregistered callers" å¯èƒ½åŸå› :

ğŸ”‘ APIé‡‘é‘°å•é¡Œ:
- APIé‡‘é‘°æ ¼å¼éŒ¯èª¤
- APIé‡‘é‘°å·²éæœŸæˆ–è¢«æ’¤éŠ·
- APIé‡‘é‘°æ²’æœ‰æ­£ç¢ºçš„æ¬Šé™

ğŸš« APIæœå‹™å•é¡Œ:
- Places API (New) æœªå•Ÿç”¨
- å°ˆæ¡ˆä¸­æ²’æœ‰å•Ÿç”¨æ­£ç¢ºçš„APIæœå‹™
- APIé…é¡å·²ç”¨å®Œ

ğŸ”’ æ¬Šé™è¨­å®šå•é¡Œ:
- APIé‡‘é‘°é™åˆ¶è¨­å®šéŒ¯èª¤
- æ²’æœ‰è¨­å®šæ­£ç¢ºçš„APIé™åˆ¶
- æ‡‰ç”¨ç¨‹å¼é™åˆ¶é˜»æ­¢äº†è«‹æ±‚

ğŸ’³ è¨ˆè²»å•é¡Œ:
- æ²’æœ‰è¨­å®šè¨ˆè²»å¸³æˆ¶
- è¨ˆè²»å¸³æˆ¶å·²åœç”¨
- è¶…å‡ºå…è²»é…é¡ä½†æ²’æœ‰ä»˜è²»

ğŸŒ è«‹æ±‚æ ¼å¼å•é¡Œ:
- ä½¿ç”¨éŒ¯èª¤çš„ç«¯é»
- æ¨™é ­æ ¼å¼ä¸æ­£ç¢º
- è«‹æ±‚æ–¹æ³•éŒ¯èª¤

å»ºè­°æª¢æŸ¥é †åº:
1. ç¢ºèªAPIé‡‘é‘°æ­£ç¢ºè¼‰å…¥
2. æª¢æŸ¥Google Cloud Consoleä¸­çš„APIæœå‹™ç‹€æ…‹
3. é©—è­‰APIé‡‘é‘°çš„é™åˆ¶è¨­å®š
4. ç¢ºèªè¨ˆè²»å¸³æˆ¶ç‹€æ…‹
5. æª¢æŸ¥APIé…é¡ä½¿ç”¨æƒ…æ³`;

            resultsDiv.className = 'results warning';
            resultsDiv.textContent = analysis;
        }

        // æª¢æŸ¥APIæœå‹™ç‹€æ…‹
        async function checkServiceStatus() {
            const resultsDiv = document.getElementById('serviceStatus');
            resultsDiv.className = 'results info';
            resultsDiv.textContent = 'ğŸ“Š æª¢æŸ¥APIæœå‹™ç‹€æ…‹...';

            const statusInfo = `
ç•¶å‰APIé‡‘é‘°: ${apiKey ? apiKey.substring(0, 15) + '...' : 'æœªè¼‰å…¥'}

éœ€è¦å•Ÿç”¨çš„æœå‹™:
âœ… Places API (New) - places.googleapis.com
âœ… Maps JavaScript API - maps-backend.googleapis.com (å¯é¸)

æª¢æŸ¥æ¸…å–®:
â–¡ å‰å¾€ Google Cloud Console
â–¡ é¸æ“‡æ­£ç¢ºçš„å°ˆæ¡ˆ
â–¡ é€²å…¥ APIs & Services > Library
â–¡ æœå°‹ "Places API (New)"
â–¡ ç¢ºèªå·²å•Ÿç”¨
â–¡ é€²å…¥ APIs & Services > Credentials
â–¡ ç·¨è¼¯APIé‡‘é‘°
â–¡ è¨­å®šAPIé™åˆ¶åŒ…å« "Places API (New)"
â–¡ ç¢ºèªè¨ˆè²»å¸³æˆ¶å·²è¨­å®š

å¦‚æœå•é¡ŒæŒçºŒ:
1. å˜—è©¦å‰µå»ºæ–°çš„APIé‡‘é‘°
2. ç¢ºèªå°ˆæ¡ˆæœ‰æ­£ç¢ºçš„æ¬Šé™
3. æª¢æŸ¥APIé…é¡å’Œä½¿ç”¨é‡
4. è¯ç¹«Google Cloudæ”¯æ´`;

            resultsDiv.className = 'results info';
            resultsDiv.textContent = statusInfo;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            testApiKeyBasic();
        });
    </script>
</body>
</html> 