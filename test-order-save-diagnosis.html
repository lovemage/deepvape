<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ä¿å­˜è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .test-result {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 10px 0;
        }
        .solution-box {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è¨‚å–®ä¿å­˜è¨ºæ–·å·¥å…·</h1>
    
    <div class="test-container">
        <h2>ç’°å¢ƒæª¢æŸ¥</h2>
        <div id="environmentStatus"></div>
        <button onclick="checkEnvironment()">æª¢æŸ¥ç’°å¢ƒ</button>
    </div>
    
    <div class="test-container">
        <h2>Netlify Functions æ¸¬è©¦</h2>
        <div id="functionsStatus"></div>
        <button onclick="testNetlifyFunctions()">æ¸¬è©¦ Functions</button>
    </div>
    
    <div class="test-container">
        <h2>è¨‚å–®ä¿å­˜æ¸¬è©¦</h2>
        <div id="orderSaveStatus"></div>
        <button onclick="testOrderSave()">æ¸¬è©¦è¨‚å–®ä¿å­˜</button>
    </div>
    
    <div class="test-container">
        <h2>æ•¸æ“šé©—è­‰</h2>
        <div id="dataVerificationStatus"></div>
        <button onclick="verifyOrderData()">é©—è­‰è¨‚å–®æ•¸æ“š</button>
    </div>

    <div class="test-container">
        <h2>ğŸ› ï¸ è§£æ±ºæ–¹æ¡ˆæŒ‡å—</h2>
        <div class="solution-box">
            <h3>å¦‚æœæ‚¨åœ¨æœ¬åœ°ç’°å¢ƒæ¸¬è©¦ï¼š</h3>
            <div class="step">
                <strong>æ­¥é©Ÿ 1:</strong> æœ¬åœ°ç’°å¢ƒç„¡æ³•ä½¿ç”¨ Netlify Functionsï¼Œéœ€è¦éƒ¨ç½²åˆ° Netlify æ‰èƒ½æ¸¬è©¦
            </div>
            <div class="step">
                <strong>æ­¥é©Ÿ 2:</strong> æ¨é€ä»£ç¢¼åˆ° GitHub å¾Œï¼ŒNetlify æœƒè‡ªå‹•éƒ¨ç½²
            </div>
            <div class="step">
                <strong>æ­¥é©Ÿ 3:</strong> åœ¨ Netlify ç”Ÿç”¢ç’°å¢ƒä¸­æ¸¬è©¦æ­¤é é¢
            </div>
        </div>

        <div class="solution-box">
            <h3>Netlify æ§åˆ¶å°è¨­å®šæª¢æŸ¥æ¸…å–®ï¼š</h3>
            <div class="step">
                <strong>âœ… Site settings â†’ Identity:</strong> 
                <br>â€¢ Enable Identity service
                <br>â€¢ Registration preferences: Invite only
                <br>â€¢ Git Gateway: Enable
            </div>
            <div class="step">
                <strong>âœ… Site settings â†’ Functions:</strong>
                <br>â€¢ Functions directory: netlify/functions
                <br>â€¢ ç¢ºèª save-order å‡½æ•¸å·²éƒ¨ç½²
            </div>
            <div class="step">
                <strong>âœ… Site settings â†’ Build & deploy:</strong>
                <br>â€¢ Build command: echo 'No build required'
                <br>â€¢ Publish directory: .
                <br>â€¢ Node.js version: 18.x
            </div>
        </div>

        <div class="solution-box">
            <h3>å¦‚æœè¨‚å–®ä¿å­˜å¤±æ•—ï¼š</h3>
            <div class="step">
                <strong>æª¢æŸ¥ 1:</strong> ç¢ºèªåœ¨ Netlify ç”Ÿç”¢ç’°å¢ƒä¸­æ¸¬è©¦ï¼ˆä¸æ˜¯æœ¬åœ°ï¼‰
            </div>
            <div class="step">
                <strong>æª¢æŸ¥ 2:</strong> æŸ¥çœ‹ Netlify æ§åˆ¶å°çš„ Functions æ—¥èªŒ
            </div>
            <div class="step">
                <strong>æª¢æŸ¥ 3:</strong> ç¢ºèª Git Gateway å·²å•Ÿç”¨ä¸”æ­£å¸¸å·¥ä½œ
            </div>
            <div class="step">
                <strong>æª¢æŸ¥ 4:</strong> æª¢æŸ¥ GitHub å€‰åº«æ˜¯å¦æœ‰æ–°çš„æäº¤è¨˜éŒ„
            </div>
        </div>
    </div>

    <script>
        // æª¢æŸ¥ç’°å¢ƒ
        function checkEnvironment() {
            const statusDiv = document.getElementById('environmentStatus');
            statusDiv.innerHTML = '<div class="status info"><span class="loading"></span> æ­£åœ¨æª¢æŸ¥ç’°å¢ƒ...</div>';
            
            let html = '<h3>ç’°å¢ƒæª¢æŸ¥çµæœ:</h3>';
            
            const currentUrl = window.location.href;
            const isLocalhost = currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1') || currentUrl.includes('file://');
            const isNetlify = currentUrl.includes('.netlify.app') || currentUrl.includes('.netlify.com');
            
            html += `<div class="status info">
                <strong>ç•¶å‰ URL:</strong> ${currentUrl}
            </div>`;
            
            if (isLocalhost) {
                html += `<div class="status warning">
                    <strong>âš ï¸ æœ¬åœ°é–‹ç™¼ç’°å¢ƒ</strong>
                    <br>Netlify Functions åœ¨æœ¬åœ°ç’°å¢ƒç„¡æ³•æ­£å¸¸å·¥ä½œ
                    <br><strong>è§£æ±ºæ–¹æ¡ˆ:</strong> è«‹å°‡ä»£ç¢¼æ¨é€åˆ° GitHubï¼Œç„¶å¾Œåœ¨ Netlify ç”Ÿç”¢ç’°å¢ƒä¸­æ¸¬è©¦
                </div>`;
            } else if (isNetlify) {
                html += `<div class="status success">
                    <strong>âœ… Netlify ç”Ÿç”¢ç’°å¢ƒ</strong>
                    <br>Functions æ‡‰è©²å¯ä»¥æ­£å¸¸å·¥ä½œ
                </div>`;
            } else {
                html += `<div class="status error">
                    <strong>âŒ æœªçŸ¥ç’°å¢ƒ</strong>
                    <br>å»ºè­°åœ¨ Netlify ç”Ÿç”¢ç’°å¢ƒä¸­æ¸¬è©¦
                </div>`;
            }
            
            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            const hasLocalStorage = typeof(Storage) !== "undefined";
            const hasFetch = typeof(fetch) !== "undefined";
            
            html += `<div class="status ${hasLocalStorage ? 'success' : 'error'}">
                <strong>LocalStorage:</strong> ${hasLocalStorage ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´'}
            </div>`;
            
            html += `<div class="status ${hasFetch ? 'success' : 'error'}">
                <strong>Fetch API:</strong> ${hasFetch ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´'}
            </div>`;
            
            statusDiv.innerHTML = html;
        }
        
        // æ¸¬è©¦ Netlify Functions
        async function testNetlifyFunctions() {
            const statusDiv = document.getElementById('functionsStatus');
            statusDiv.innerHTML = '<div class="status info"><span class="loading"></span> æ­£åœ¨æ¸¬è©¦ Netlify Functions...</div>';
            
            let html = '<h3>Netlify Functions æ¸¬è©¦çµæœ:</h3>';
            
            // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç’°å¢ƒ
            const isLocalhost = window.location.href.includes('localhost') || 
                               window.location.href.includes('127.0.0.1') || 
                               window.location.href.includes('file://');
            
            if (isLocalhost) {
                html += `<div class="status warning">
                    <strong>âš ï¸ æœ¬åœ°ç’°å¢ƒé™åˆ¶</strong>
                    <br>Netlify Functions åªèƒ½åœ¨ Netlify ç”Ÿç”¢ç’°å¢ƒä¸­é‹è¡Œ
                    <br>è«‹æ¨é€ä»£ç¢¼åˆ° GitHub ä¸¦åœ¨ Netlify éƒ¨ç½²å¾Œæ¸¬è©¦
                </div>`;
                statusDiv.innerHTML = html;
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/save-order', {
                    method: 'OPTIONS'
                });
                
                html += `<div class="status ${response.ok ? 'success' : 'error'}">
                    <strong>save-order Function:</strong> 
                    ${response.ok ? 'âœ… å¯è¨ªå•' : 'âŒ ç„¡æ³•è¨ªå•'} 
                    (ç‹€æ…‹ç¢¼: ${response.status})
                </div>`;
                
                if (response.ok) {
                    html += `<div class="status success">
                        âœ… Netlify Functions æ­£å¸¸é‹è¡Œï¼Œå¯ä»¥é€²è¡Œè¨‚å–®ä¿å­˜æ¸¬è©¦
                    </div>`;
                } else {
                    html += `<div class="status error">
                        âŒ Functions ç„¡æ³•è¨ªå•ï¼Œè«‹æª¢æŸ¥ï¼š
                        <br>1. ç¢ºèªä»£ç¢¼å·²æ¨é€åˆ° GitHub
                        <br>2. ç¢ºèª Netlify éƒ¨ç½²æˆåŠŸ
                        <br>3. æª¢æŸ¥ netlify/functions ç›®éŒ„æ˜¯å¦å­˜åœ¨
                    </div>`;
                }
                
            } catch (error) {
                html += `<div class="status error">
                    <strong>save-order Function:</strong> âŒ é€£æ¥å¤±æ•—
                    <br>éŒ¯èª¤: ${error.message}
                    <br><strong>å¯èƒ½åŸå› :</strong>
                    <br>â€¢ Functions æœªæ­£ç¢ºéƒ¨ç½²
                    <br>â€¢ ç¶²è·¯é€£æ¥å•é¡Œ
                    <br>â€¢ Netlify æœå‹™ç•°å¸¸
                </div>`;
            }
            
            statusDiv.innerHTML = html;
        }
        
        // æ¸¬è©¦è¨‚å–®ä¿å­˜
        async function testOrderSave() {
            const statusDiv = document.getElementById('orderSaveStatus');
            statusDiv.innerHTML = '<div class="status info"><span class="loading"></span> æ­£åœ¨æ¸¬è©¦è¨‚å–®ä¿å­˜...</div>';
            
            let html = '<h3>è¨‚å–®ä¿å­˜æ¸¬è©¦çµæœ:</h3>';
            
            // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç’°å¢ƒ
            const isLocalhost = window.location.href.includes('localhost') || 
                               window.location.href.includes('127.0.0.1') || 
                               window.location.href.includes('file://');
            
            if (isLocalhost) {
                html += `<div class="status warning">
                    <strong>âš ï¸ ç„¡æ³•åœ¨æœ¬åœ°ç’°å¢ƒæ¸¬è©¦</strong>
                    <br>è«‹åœ¨ Netlify ç”Ÿç”¢ç’°å¢ƒä¸­æ¸¬è©¦æ­¤åŠŸèƒ½
                </div>`;
                statusDiv.innerHTML = html;
                return;
            }
            
            const testOrder = {
                orderId: 'DIAGNOSIS_TEST_' + Date.now(),
                orderDate: new Date().toISOString(),
                status: 'pending',
                customer: {
                    name: 'è¨ºæ–·æ¸¬è©¦å®¢æˆ¶',
                    phone: '0912345678',
                    email: 'test@example.com'
                },
                store: {
                    id: '250094',
                    name: 'æ¸¬è©¦é–€å¸‚',
                    address: 'æ¸¬è©¦åœ°å€'
                },
                items: [
                    {
                        productId: 'test-product',
                        productName: 'è¨ºæ–·æ¸¬è©¦ç”¢å“',
                        variant: 'é»‘è‰²',
                        quantity: 1,
                        unitPrice: 100,
                        totalPrice: 100
                    }
                ],
                subtotal: 100,
                shipping: 60,
                total: 160,
                paymentMethod: 'cash_on_delivery',
                shippingMethod: 'convenience_store',
                lastUpdated: new Date().toISOString()
            };
            
            html += `<div class="status info">
                <strong>æ¸¬è©¦è¨‚å–® ID:</strong> ${testOrder.orderId}
            </div>`;
            
            try {
                const response = await fetch('/.netlify/functions/save-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testOrder)
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { rawResponse: responseText };
                }
                
                html += `<div class="status ${response.ok ? 'success' : 'error'}">
                    <strong>API å›æ‡‰:</strong> 
                    ${response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'} 
                    (ç‹€æ…‹ç¢¼: ${response.status})
                </div>`;
                
                if (response.ok && responseData.success) {
                    html += `<div class="status success">
                        ğŸ‰ <strong>è¨‚å–®ä¿å­˜æˆåŠŸï¼</strong>
                        <br>è¨‚å–® ID: ${testOrder.orderId}
                        <br><strong>é‡è¦:</strong> è«‹ç­‰å¾… 1-5 åˆ†é˜å¾Œï¼š
                        <br>1. é»æ“Šä¸‹æ–¹ã€Œé©—è­‰è¨‚å–®æ•¸æ“šã€æŒ‰éˆ•
                        <br>2. æª¢æŸ¥ GitHub å€‰åº«æ˜¯å¦æœ‰æ–°çš„æäº¤è¨˜éŒ„
                    </div>`;
                } else {
                    html += `<div class="status error">
                        âŒ <strong>è¨‚å–®ä¿å­˜å¤±æ•—</strong>
                        <br>éŒ¯èª¤è¨Šæ¯: ${responseData.error || responseData.message || 'æœªçŸ¥éŒ¯èª¤'}
                        <br><strong>å»ºè­°æª¢æŸ¥:</strong>
                        <br>â€¢ Netlify Functions æ—¥èªŒ
                        <br>â€¢ Git Gateway è¨­å®š
                        <br>â€¢ æ–‡ä»¶æ¬Šé™è¨­å®š
                    </div>`;
                }
                
                html += `<div class="status info">
                    <strong>è©³ç´°å›æ‡‰:</strong>
                    <pre>${JSON.stringify(responseData, null, 2)}</pre>
                </div>`;
                
            } catch (error) {
                html += `<div class="status error">
                    <strong>è«‹æ±‚å¤±æ•—:</strong> ${error.message}
                    <br><strong>å¯èƒ½åŸå› :</strong>
                    <br>â€¢ ç¶²è·¯é€£æ¥å•é¡Œ
                    <br>â€¢ Functions æœå‹™ç•°å¸¸
                    <br>â€¢ CORS è¨­å®šå•é¡Œ
                </div>`;
            }
            
            statusDiv.innerHTML = html;
        }
        
        // é©—è­‰è¨‚å–®æ•¸æ“š
        async function verifyOrderData() {
            const statusDiv = document.getElementById('dataVerificationStatus');
            statusDiv.innerHTML = '<div class="status info"><span class="loading"></span> æ­£åœ¨é©—è­‰è¨‚å–®æ•¸æ“š...</div>';
            
            let html = '<h3>æ•¸æ“šé©—è­‰çµæœ:</h3>';
            
            try {
                const response = await fetch('/data/orders.json?t=' + Date.now()); // æ·»åŠ æ™‚é–“æˆ³é¿å…ç·©å­˜
                
                if (response.ok) {
                    const ordersData = await response.json();
                    
                    html += `<div class="status success">
                        <strong>orders.json:</strong> âœ… æ–‡ä»¶å­˜åœ¨ä¸”å¯è®€å–
                    </div>`;
                    
                    html += `<div class="status info">
                        <strong>è¨‚å–®æ•¸é‡:</strong> ${ordersData.orders?.length || 0} ç­†
                    </div>`;
                    
                    if (ordersData.orders && ordersData.orders.length > 0) {
                        const recentOrders = ordersData.orders.slice(-3);
                        html += `<div class="status info">
                            <strong>æœ€è¿‘ 3 ç­†è¨‚å–®:</strong>
                            <pre>${JSON.stringify(recentOrders.map(order => ({
                                orderId: order.orderId,
                                orderDate: order.orderDate,
                                customer: order.customer?.name,
                                total: order.total,
                                status: order.status
                            })), null, 2)}</pre>
                        </div>`;
                        
                        const testOrders = ordersData.orders.filter(order => 
                            order.orderId.includes('TEST') || order.orderId.includes('DIAGNOSIS')
                        );
                        
                        if (testOrders.length > 0) {
                            html += `<div class="status success">
                                <strong>æ¸¬è©¦è¨‚å–®:</strong> âœ… æ‰¾åˆ° ${testOrders.length} ç­†æ¸¬è©¦è¨‚å–®
                                <br>é€™è¡¨ç¤ºè¨‚å–®ä¿å­˜åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼
                            </div>`;
                        } else {
                            html += `<div class="status warning">
                                <strong>æ¸¬è©¦è¨‚å–®:</strong> âš ï¸ æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦è¨‚å–®
                                <br>è«‹å…ˆåŸ·è¡Œã€Œæ¸¬è©¦è¨‚å–®ä¿å­˜ã€åŠŸèƒ½
                            </div>`;
                        }
                    } else {
                        html += `<div class="status warning">
                            <strong>è¨‚å–®æ•¸æ“š:</strong> âš ï¸ æ²’æœ‰è¨‚å–®è¨˜éŒ„
                            <br>é€™å¯èƒ½è¡¨ç¤ºï¼š
                            <br>â€¢ é‚„æ²’æœ‰æˆåŠŸä¿å­˜éè¨‚å–®
                            <br>â€¢ Git Gateway æ²’æœ‰æ­£ç¢ºåŒæ­¥æ•¸æ“š
                        </div>`;
                    }
                    
                } else {
                    html += `<div class="status error">
                        <strong>orders.json:</strong> âŒ ç„¡æ³•è®€å– (ç‹€æ…‹ç¢¼: ${response.status})
                        <br>é€™å¯èƒ½è¡¨ç¤ºæ–‡ä»¶ä¸å­˜åœ¨æˆ–æ¬Šé™å•é¡Œ
                    </div>`;
                }
                
                // æª¢æŸ¥çµ±è¨ˆæ–‡ä»¶
                try {
                    const statsResponse = await fetch('/data/order_stats.json?t=' + Date.now());
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        html += `<div class="status success">
                            <strong>order_stats.json:</strong> âœ… çµ±è¨ˆæ–‡ä»¶å­˜åœ¨
                        </div>`;
                        
                        if (statsData.stats) {
                            html += `<div class="status info">
                                <strong>çµ±è¨ˆæ•¸æ“š:</strong>
                                <br>ç¸½è¨‚å–®æ•¸: ${statsData.stats.totalOrders || 0}
                                <br>ç¸½æ”¶å…¥: NT$ ${statsData.stats.totalRevenue || 0}
                                <br>æœ€å¾Œæ›´æ–°: ${statsData.stats.lastUpdated || 'N/A'}
                            </div>`;
                        }
                    }
                } catch (e) {
                    html += `<div class="status warning">
                        <strong>order_stats.json:</strong> âš ï¸ çµ±è¨ˆæ–‡ä»¶ç„¡æ³•è®€å–
                    </div>`;
                }
                
            } catch (error) {
                html += `<div class="status error">
                    <strong>é©—è­‰å¤±æ•—:</strong> ${error.message}
                </div>`;
            }
            
            // æ·»åŠ  Git æª¢æŸ¥æé†’
            html += `<div class="status info">
                <strong>ğŸ“‹ Git æäº¤æª¢æŸ¥:</strong>
                <br>å¦‚æœä¸Šè¿°æ¸¬è©¦æˆåŠŸï¼Œè«‹æª¢æŸ¥ GitHub å€‰åº«ï¼š
                <br>1. å‰å¾€: <a href="https://github.com/lovemage/deepvape/commits" target="_blank">GitHub æäº¤æ­·å²</a>
                <br>2. å°‹æ‰¾åŒ…å« "orders.json" çš„è‡ªå‹•æäº¤
                <br>3. æäº¤è€…æ‡‰è©²æ˜¯ "Netlify CMS" æˆ–é¡ä¼¼çš„è‡ªå‹•åŒ–å¸³æˆ¶
                <br>4. æäº¤æ™‚é–“æ‡‰è©²åœ¨æ¸¬è©¦å¾Œçš„ 1-5 åˆ†é˜å…§
            </div>`;
            
            statusDiv.innerHTML = html;
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ç’°å¢ƒ
        document.addEventListener('DOMContentLoaded', () => {
            checkEnvironment();
        });
    </script>
</body>
</html> 