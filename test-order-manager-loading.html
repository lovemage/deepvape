<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrderManager 載入測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🔍 OrderManager 載入狀態測試</h1>
    
    <div class="test-container">
        <h2>系統狀態檢查</h2>
        <div id="systemStatus"></div>
        <button onclick="checkSystemStatus()">重新檢查系統狀態</button>
    </div>
    
    <div class="test-container">
        <h2>腳本載入測試</h2>
        <div id="scriptStatus"></div>
        <button onclick="checkScriptLoading()">檢查腳本載入</button>
    </div>
    
    <div class="test-container">
        <h2>OrderManager 功能測試</h2>
        <div id="functionStatus"></div>
        <button onclick="testOrderManagerFunctions()">測試 OrderManager 功能</button>
    </div>
    
    <div class="test-container">
        <h2>模擬訂單創建測試</h2>
        <div id="orderTestStatus"></div>
        <button onclick="testOrderCreation()">測試訂單創建</button>
    </div>

    <!-- 載入管理系統腳本 -->
    <script src="js/product-manager.js"></script>
    <script src="js/inventory-manager.js"></script>
    <script src="js/order-manager.js"></script>

    <script>
        // 檢查系統狀態
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            let html = '';
            
            // 檢查各個管理器
            const managers = [
                { name: 'ProductManager', obj: window.ProductManager },
                { name: 'InventoryManager', obj: window.InventoryManager },
                { name: 'OrderManager', obj: window.OrderManager }
            ];
            
            managers.forEach(manager => {
                const exists = !!manager.obj;
                const initialized = manager.obj?.initialized;
                
                html += `<div class="status ${exists ? 'success' : 'error'}">
                    <strong>${manager.name}:</strong> 
                    ${exists ? '✅ 已載入' : '❌ 未載入'}
                    ${exists && initialized !== undefined ? 
                        (initialized ? ' (已初始化)' : ' (未初始化)') : ''}
                </div>`;
            });
            
            statusDiv.innerHTML = html;
        }
        
        // 檢查腳本載入
        function checkScriptLoading() {
            const statusDiv = document.getElementById('scriptStatus');
            let html = '';
            
            // 檢查腳本文件是否存在
            const scripts = [
                'js/product-manager.js',
                'js/inventory-manager.js', 
                'js/order-manager.js'
            ];
            
            html += '<h3>腳本載入狀態:</h3>';
            
            scripts.forEach(script => {
                const scriptElement = document.querySelector(`script[src="${script}"]`);
                html += `<div class="status ${scriptElement ? 'success' : 'warning'}">
                    <strong>${script}:</strong> 
                    ${scriptElement ? '✅ 腳本標籤存在' : '⚠️ 腳本標籤不存在'}
                </div>`;
            });
            
            statusDiv.innerHTML = html;
        }
        
        // 測試 OrderManager 功能
        function testOrderManagerFunctions() {
            const statusDiv = document.getElementById('functionStatus');
            let html = '';
            
            if (!window.OrderManager) {
                html = '<div class="status error">❌ OrderManager 未載入</div>';
                statusDiv.innerHTML = html;
                return;
            }
            
            // 檢查關鍵方法
            const methods = [
                'init',
                'createOrderFromCart',
                'loadOrders',
                'syncOrderToCMS',
                'generateOrderId'
            ];
            
            html += '<h3>OrderManager 方法檢查:</h3>';
            
            methods.forEach(method => {
                const exists = typeof window.OrderManager[method] === 'function';
                html += `<div class="status ${exists ? 'success' : 'error'}">
                    <strong>${method}():</strong> 
                    ${exists ? '✅ 方法存在' : '❌ 方法不存在'}
                </div>`;
            });
            
            // 檢查屬性
            html += '<h3>OrderManager 屬性:</h3>';
            html += `<div class="status info">
                <strong>initialized:</strong> ${window.OrderManager.initialized}
            </div>`;
            html += `<div class="status info">
                <strong>orders.length:</strong> ${window.OrderManager.orders?.length || 0}
            </div>`;
            
            statusDiv.innerHTML = html;
        }
        
        // 測試訂單創建
        async function testOrderCreation() {
            const statusDiv = document.getElementById('orderTestStatus');
            statusDiv.innerHTML = '<div class="status info">🔄 正在測試訂單創建...</div>';
            
            try {
                // 模擬購物車數據
                const testCart = [
                    {
                        id: 'test-product-1',
                        name: '測試產品',
                        price: 100,
                        quantity: 1,
                        color: '黑色',
                        image: 'test.jpg'
                    }
                ];
                
                localStorage.setItem('cart', JSON.stringify(testCart));
                
                // 模擬客戶信息
                const customerInfo = {
                    name: '測試客戶',
                    phone: '0912345678',
                    email: 'test@example.com'
                };
                
                const shippingInfo = {
                    method: 'convenience_store',
                    address: '測試地址'
                };
                
                const paymentInfo = {
                    method: 'cash_on_delivery'
                };
                
                let result;
                let html = '';
                
                if (window.OrderManager && typeof window.OrderManager.createOrderFromCart === 'function') {
                    // 測試 OrderManager
                    html += '<div class="status info">📋 使用 OrderManager 測試...</div>';
                    
                    if (!window.OrderManager.initialized) {
                        await window.OrderManager.init();
                    }
                    
                    result = await window.OrderManager.createOrderFromCart(
                        customerInfo, shippingInfo, paymentInfo
                    );
                    
                    if (result && result.success) {
                        html += '<div class="status success">✅ OrderManager 訂單創建成功</div>';
                        html += `<pre>${JSON.stringify(result.order, null, 2)}</pre>`;
                    } else {
                        html += '<div class="status error">❌ OrderManager 訂單創建失敗</div>';
                        html += `<div class="status error">錯誤: ${result?.error || '未知錯誤'}</div>`;
                    }
                } else {
                    html += '<div class="status warning">⚠️ OrderManager 不可用，無法測試</div>';
                }
                
                // 清理測試數據
                localStorage.removeItem('cart');
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ 測試失敗: ${error.message}</div>`;
                console.error('測試訂單創建失敗:', error);
            }
        }
        
        // 頁面載入時自動檢查
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkSystemStatus();
                checkScriptLoading();
            }, 1000);
        });
        
        // 定期更新狀態
        setInterval(checkSystemStatus, 5000);
    </script>
</body>
</html> 